<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://cdnjs.cloudflare.com https://www.gstatic.com; style-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://cdnjs.cloudflare.com;">
    <title>Production Planner 2025 (Graphic Team)</title>
    
    <!-- FAVICON -->
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/Fusemxd/task.fuse.hyg/37e17d0f0f712995e6e21546cba558911aecb74a/3.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@200;300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --main-color: #14b8a6;
            --main-bg: #ccfbf1;
        }
        
        body { 
            font-family: 'Kanit', sans-serif; 
            background-color: #f8fafc; 
            color: #334155; 
            -webkit-tap-highlight-color: transparent; 
        }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }

        .glass { 
            background: rgba(255, 255, 255, 0.85); 
            backdrop-filter: blur(12px); 
            -webkit-backdrop-filter: blur(12px); 
            border-bottom: 1px solid rgba(255, 255, 255, 0.3); 
        }
        
        .glass-card { 
            background: rgba(255, 255, 255, 0.9); 
            backdrop-filter: blur(8px); 
            border: 1px solid rgba(255, 255, 255, 0.5); 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); 
        }

        .status-todo { background-color: #f1f5f9; color: #64748b; border: 1px solid #e2e8f0; }
        .status-doing { background-color: #eff6ff; color: #3b82f6; border: 1px solid #dbeafe; }
        .status-draft { background-color: #f5f3ff; color: #8b5cf6; border: 1px solid #ede9fe; }
        .status-done { background-color: #ecfdf5; color: #10b981; border: 1px solid #d1fae5; }
        .status-cancelled { background-color: #f8fafc; color: #94a3b8; border: 1px solid #e2e8f0; opacity: 0.8; }
        .card-cancelled { opacity: 0.6; filter: grayscale(100%); }

        .theme-graphic { --main-color: #14b8a6; --main-bg: #ccfbf1; }
        
        .nav-btn.active { 
            background-color: var(--main-color, #14b8a6); 
            color: white; 
            font-weight: 500; 
            box-shadow: 0 4px 12px rgba(20, 184, 166, 0.3); 
            border: none;
        }
        
        .modal-backdrop { background-color: rgba(15, 23, 42, 0.4); backdrop-filter: blur(8px); }
        .img-overlay { background: rgba(0,0,0,0.92); backdrop-filter: blur(10px); }

        .task-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .task-card:hover { 
            transform: translateY(-4px); 
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.01); 
        }

        /* ========== TOAST NOTIFICATION ========== */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 14px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 100;
            animation: slideIn 0.3s ease-out;
            font-size: 14px;
            max-width: 300px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .toast.success { background-color: #10b981; }
        .toast.error { background-color: #ef4444; }
        .toast.info { background-color: #3b82f6; }
        .toast.warning { background-color: #f59e0b; }
        
        @keyframes slideIn { 
            from { 
                transform: translateX(400px); 
                opacity: 0; 
            } 
            to { 
                transform: translateX(0); 
                opacity: 1; 
            } 
        }

        @keyframes slideOut { 
            from { 
                transform: translateX(0); 
                opacity: 1; 
            } 
            to { 
                transform: translateX(400px); 
                opacity: 0; 
            } 
        }

        /* ========== LOADING SPINNER ========== */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ========== ACCESSIBILITY ========== */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* ========== DARK MODE (Optional) ========== */
        @media (prefers-color-scheme: dark) {
            body {
                background-color: #1e293b;
                color: #e2e8f0;
            }
            .glass { background: rgba(30, 41, 59, 0.7); }
            .glass-card { background: rgba(30, 41, 59, 0.9); }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col pb-20 lg:pb-0 theme-graphic bg-slate-50" id="mainBody">

    <!-- LOGIN OVERLAY -->
    <div id="loginOverlay" class="fixed inset-0 z-[60] bg-slate-50 flex items-center justify-center fade-in p-4 overflow-y-auto">
        <div class="glass-card p-8 md:p-10 rounded-3xl shadow-2xl w-full max-w-sm my-auto text-center border border-white">
            <div class="mb-8 relative">
                <div class="w-20 h-20 bg-gradient-to-tr from-teal-400 to-emerald-600 rounded-2xl mx-auto flex items-center justify-center shadow-lg rotate-3">
                    <img src="https://raw.githubusercontent.com/Fusemxd/task.fuse.hyg/37e17d0f0f712995e6e21546cba558911aecb74a/3.png" 
                         alt="Task Fuse Logo" class="w-16 h-16 object-contain drop-shadow-md -rotate-3 bg-white rounded-xl p-1">
                </div>
            </div>
            <h2 class="text-3xl font-bold text-slate-800 mb-1">Welcome Back</h2>
            <p class="text-slate-500 text-sm mb-8">Production Planner 2025</p>
            
            <form onsubmit="handleLogin(event)" class="space-y-4 text-left">
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1 ml-1" for="loginEmail">Email</label>
                    <input type="email" id="loginEmail" required class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-teal-500 focus:border-transparent" placeholder="your@email.com" aria-label="Email address">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1 ml-1" for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" required class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-teal-500 focus:border-transparent" placeholder="••••••••" aria-label="Password">
                </div>
                <div id="loginError" class="text-red-500 text-xs text-center hidden bg-red-50 p-2 rounded-lg border border-red-100" role="alert"></div>
                <button type="submit" id="loginBtn" class="w-full py-3 bg-slate-800 text-white rounded-xl hover:bg-slate-900 transition font-bold shadow-lg hover:shadow-xl transform active:scale-95 flex justify-center items-center gap-2" aria-busy="false">
                    <span>Login</span> <i class="fa-solid fa-arrow-right"></i>
                </button>
            </form>

            <div class="relative my-8">
                <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-slate-200"></div></div>
                <div class="relative flex justify-center text-xs"><span class="px-2 bg-slate-50 text-slate-400">or continue as</span></div>
            </div>

            <button onclick="handleGuestLogin()" id="guestBtn" type="button" class="w-full py-3 bg-white text-slate-600 rounded-xl hover:bg-slate-50 transition font-medium text-sm flex justify-center items-center gap-2 border border-slate-200">
                <i class="fa-regular fa-eye"></i> <span>Guest Mode</span>
            </button>
        </div>
    </div>

    <!-- Navbar -->
    <nav class="glass sticky top-0 z-30">
        <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-teal-400 to-teal-600 rounded-xl flex items-center justify-center text-white shadow-md">
                        <i class="fa-solid fa-layer-group"></i>
                    </div>
                    <div class="hidden md:block">
                        <h1 class="text-base font-bold text-slate-800 leading-none">Production</h1>
                        <p class="text-[10px] text-teal-600 font-medium tracking-wide">GRAPHIC TEAM</p>
                    </div>
                </div>
                <div class="h-6 w-px bg-slate-200 mx-1 hidden md:block"></div>
                <div class="flex items-center gap-2 bg-slate-50 px-3 py-1.5 rounded-full border border-slate-100">
                    <div class="w-6 h-6 rounded-full bg-slate-200 flex items-center justify-center text-slate-400 text-xs overflow-hidden">
                        <i class="fa-solid fa-user"></i>
                    </div>
                    <span id="userEmailDisplay" class="text-xs text-slate-600 font-medium truncate max-w-[100px]">Guest</span>
                </div>
            </div>
            
            <div class="flex items-center gap-3">
                <button onclick="switchView('planner')" id="tab-planner" class="nav-btn active px-4 py-2 rounded-full text-sm transition-all flex items-center gap-2" aria-pressed="true">
                    <i class="fa-regular fa-calendar"></i> <span class="hidden sm:inline">Planner</span>
                </button>
                <button onclick="switchView('dashboard')" id="tab-dashboard" class="nav-btn bg-white text-slate-600 border border-slate-200 hover:bg-slate-50 px-4 py-2 rounded-full text-sm transition-all flex items-center gap-2" aria-pressed="false">
                    <i class="fa-solid fa-chart-pie"></i> <span class="hidden sm:inline">Dashboard</span>
                </button>
                <button onclick="handleLogout()" id="logoutBtn" class="ml-2 text-slate-300 hover:text-red-500 transition px-2 hidden" title="Logout" aria-label="Logout">
                    <i class="fa-solid fa-power-off"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-grow max-w-7xl mx-auto px-4 py-6 w-full relative">
        <div id="loadingOverlay" class="absolute inset-0 bg-white/80 z-40 hidden flex items-center justify-center backdrop-blur-sm rounded-3xl min-h-[50vh]">
            <div class="text-center">
                <div class="spinner mx-auto mb-3" style="border-width: 4px; width: 48px; height: 48px; border-color: rgba(20, 184, 166, 0.3); border-top-color: #14b8a6;"></div>
                <p class="text-sm text-slate-500 font-medium animate-pulse">Syncing Data...</p>
            </div>
        </div>

        <!-- VIEW 1: PLANNER -->
        <div id="view-planner" class="grid grid-cols-1 lg:grid-cols-12 gap-6 fade-in">
            <!-- Mobile Month Nav -->
            <div class="lg:hidden col-span-1 glass-card rounded-2xl p-2 sticky top-20 z-20 overflow-hidden">
                <div class="flex overflow-x-auto no-scrollbar gap-2" id="mobileMonthNavigator"></div>
            </div>

            <!-- Desktop Sidebar -->
            <aside class="hidden lg:block lg:col-span-3 space-y-6">
                <div class="bg-white rounded-3xl shadow-sm p-5 border border-slate-100 sticky top-24">
                    <div class="flex justify-between items-center mb-4 pb-3 border-b border-slate-50">
                        <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">Timeline</span>
                        <span class="text-[10px] bg-slate-100 text-slate-500 px-2 py-1 rounded-full font-medium">2025</span>
                    </div>
                    <div class="space-y-1.5" id="monthNavigator"></div>
                </div>
            </aside>

            <section class="lg:col-span-9 space-y-6">
                <!-- Header Card -->
                <div id="headerCard" class="bg-gradient-to-r from-teal-500 to-emerald-600 text-white rounded-3xl p-6 md:p-8 shadow-xl shadow-teal-500/20 flex justify-between items-center relative overflow-hidden">
                    <div class="relative z-10">
                        <div class="flex items-center gap-3 mb-2">
                            <span class="text-xs font-medium bg-white/20 backdrop-blur-sm px-3 py-1 rounded-full border border-white/10">Month View</span>
                        </div>
                        <h2 class="text-3xl md:text-4xl font-bold tracking-tight mb-1" id="currentMonthTitle">มกราคม</h2>
                        <div class="flex items-center gap-2 opacity-90 text-sm font-light">
                            <i class="fa-solid fa-rocket"></i> Launching: <span id="launchMonthTitle" class="font-medium">กุมภาพันธ์</span>
                        </div>
                    </div>
                    <div id="guestBadge" class="hidden absolute top-6 right-6 bg-black/20 px-3 py-1 rounded-full text-xs font-medium border border-white/20 backdrop-blur-sm">
                        <i class="fa-regular fa-eye mr-1"></i> View Only
                    </div>
                    <div class="absolute right-0 bottom-0 opacity-10 transform translate-x-1/4 translate-y-1/4">
                        <i class="fa-regular fa-calendar-check text-[10rem]"></i>
                    </div>
                </div>

                <!-- Filters, Search & Add Button -->
                <div class="flex flex-col sm:flex-row items-stretch sm:items-center justify-between gap-4">
                    <div class="flex flex-col sm:flex-row gap-3 w-full sm:w-auto">
                        <div class="flex gap-2 overflow-x-auto no-scrollbar pb-1 sm:pb-0 shrink-0" id="filterContainer" role="group" aria-label="Task filters"></div>
                        <div class="relative w-full sm:w-64 shrink-0 group">
                            <input type="text" id="taskSearchInput" oninput="liveSearchTasks()" placeholder="Search tasks..." 
                                class="w-full bg-white border border-slate-200 rounded-full px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-teal-500 pl-10 shadow-sm transition-all" aria-label="Search tasks" autocomplete="off">
                            <i class="fa-solid fa-magnifying-glass absolute left-3.5 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none"></i>
                        </div>
                    </div>
                    
                    <button id="addTaskBtn" onclick="openAddTaskModal()" class="hidden flex justify-center items-center gap-2 px-5 py-2.5 text-sm font-bold text-white bg-slate-800 hover:bg-slate-900 rounded-full shadow-lg hover:shadow-slate-500/30 transition">
                        <i class="fa-solid fa-plus"></i> <span class="hidden sm:inline">New Task</span><span class="sm:hidden">Add</span>
                    </button>
                </div>

                <div id="taskList" class="grid grid-cols-1 md:grid-cols-2 gap-4 pb-20 lg:pb-0" role="list"></div>
            </section>
        </div>

        <!-- VIEW 2: DASHBOARD -->
        <div id="view-dashboard" class="hidden fade-in space-y-6 pb-20 lg:pb-0">
            <h3 id="dashboardTitle" class="text-2xl font-bold text-slate-800">Dashboard Overview</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 col-span-2 relative overflow-hidden">
                    <div class="absolute top-0 right-0 -mt-4 -mr-4 w-24 h-24 bg-teal-50 rounded-full opacity-50 blur-xl"></div>
                    <h4 class="font-bold text-slate-800 mb-6 text-lg flex items-center gap-2">
                        <span class="w-1 h-6 bg-teal-500 rounded-full"></span> Monthly Progress
                    </h4>
                    <div class="h-64 relative z-10"><canvas id="monthlyChart" aria-label="Monthly progress chart"></canvas></div>
                </div>
                
                <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 space-y-4">
                    <h4 class="font-bold text-slate-800 text-lg mb-4">Task Status</h4>
                    <div class="relative overflow-hidden p-4 bg-slate-50 rounded-2xl border border-slate-100">
                        <span class="text-slate-500 text-xs font-bold uppercase">To Do</span>
                        <div class="text-3xl font-bold text-slate-700 mt-1" id="stat-todo">0</div>
                    </div>
                    <div class="relative overflow-hidden p-4 bg-blue-50 rounded-2xl border border-blue-100">
                        <span class="text-blue-500 text-xs font-bold uppercase">In Progress</span>
                        <div class="text-3xl font-bold text-blue-700 mt-1" id="stat-doing">0</div>
                    </div>
                    <div class="relative overflow-hidden p-4 bg-purple-50 rounded-2xl border border-purple-100">
                        <span class="text-purple-500 text-xs font-bold uppercase">Review</span>
                        <div class="text-3xl font-bold text-purple-700 mt-1" id="stat-draft">0</div>
                    </div>
                    <div class="relative overflow-hidden p-4 bg-emerald-50 rounded-2xl border border-emerald-100">
                        <span class="text-emerald-500 text-xs font-bold uppercase">Completed</span>
                        <div class="text-3xl font-bold text-emerald-700 mt-1" id="stat-done">0</div>
                    </div>
                    <div class="flex justify-between items-center px-4 py-2 bg-gray-50 rounded-xl border border-gray-100">
                        <span class="text-gray-400 text-xs font-medium"><i class="fa-solid fa-ban mr-1"></i> Cancelled</span>
                        <span class="font-bold text-gray-500" id="stat-cancelled">0</span>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden">
                <div class="p-5 border-b border-slate-50 flex justify-between items-center bg-slate-50/30">
                    <div>
                        <h4 class="font-bold text-slate-700">Detailed Breakdown</h4>
                        <p class="text-xs text-slate-400 mt-1">Click rows to expand details</p>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left min-w-[600px]">
                        <thead class="text-xs text-slate-400 uppercase bg-slate-50/50 border-b border-slate-100">
                            <tr>
                                <th class="px-6 py-4 font-semibold w-1/4">Month</th>
                                <th class="px-6 py-4 font-semibold">Total Tasks</th>
                                <th class="px-6 py-4 font-semibold w-1/3">Progress</th>
                                <th class="px-6 py-4 font-semibold">%</th>
                                <th class="px-6 py-4 font-semibold text-right">Status</th>
                            </tr>
                        </thead>
                        <tbody id="dashboardTableBody" class="divide-y divide-slate-50 font-light text-slate-600"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- MODALS PLACEHOLDER -->
    <!-- (All modals remain the same as original - task detail, add/edit, delete confirmation, image viewer) -->
    <div id="taskDetailModal" class="fixed inset-0 z-[65] hidden"></div>
    <div id="addTaskModal" class="fixed inset-0 z-50 hidden"></div>
    <div id="deleteConfirmModal" class="fixed inset-0 z-50 hidden"></div>
    <div id="imageViewerModal" class="fixed inset-0 z-[70] hidden"></div>

    <!-- Scripts -->
    <script type="module">
        // ========== FIREBASE CONFIG ========== 
        // NOTE: Move to .env file in production
        const FIREBASE_CONFIG = {
            apiKey: process.env.REACT_APP_FIREBASE_API_KEY || "AIzaSyBdmGg7vi9QAD04TFM9suKvjoId_HO7s18",
            authDomain: "fusetaskhyg.firebaseapp.com",
            projectId: "fusetaskhyg",
            storageBucket: "fusetaskhyg.firebasestorage.app",
            messagingSenderId: "667329598644",
            appId: "1:667329598644:web:79abb5f6a20739d14f73e1"
        };

        const APP_CONFIG = {
            appId: 'graphic-planner-default',
            maxImageSize: 5 * 1024 * 1024,
            searchDebounce: 300,
            imageCompressionQuality: 0.8,
            maxTasks: 100 // Pagination limit
        };

        // ========== CONSTANTS ========== 
        const MONTH_NAMES_TH = ["มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน", "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"];
        const LAUNCH_MONTHS_TH = ["กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน", "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม", "มกราคม"];
        const GRAPHIC_CHANNELS = ["Online Platform", "Social Media", "Offline/Print", "Internal"];
        
        const STATUS_CONFIG = {
            'todo': { label: 'To Do', colorClass: 'status-todo', icon: 'fa-regular fa-circle' },
            'doing': { label: 'Doing', colorClass: 'status-doing', icon: 'fa-solid fa-spinner fa-spin' },
            'draft': { label: 'Review', colorClass: 'status-draft', icon: 'fa-regular fa-eye' },
            'done': { label: 'Done', colorClass: 'status-done', icon: 'fa-solid fa-check-circle' },
            'cancelled': { label: 'Cancelled', colorClass: 'status-cancelled', icon: 'fa-solid fa-ban' }
        };
        
        const KPI_OPTIONS = [
            { value: "Financials (1.1)", label: "1.1 (P&L)" },
            { value: "Profitability (1.2)", label: "1.2 (Profit)" },
            { value: "Reforecasting (1.3)", label: "1.3 (Budget)" },
            { value: "Pricing/Cost (1.4)", label: "1.4 (Pricing)" },
            { value: "Margin/Cost (1.5)", label: "1.5 (Margin)" },
            { value: "New Products (1.6)", label: "1.6 (New Prod)" },
            { value: "Customer Exp (2.1)", label: "2.1 (Exp)" },
            { value: "Retention/Loyalty (2.2)", label: "2.2 (Loyalty)" },
            { value: "Market Presence (2.3)", label: "2.3 (Market)" },
            { value: "Non-Compliance (5.1)", label: "5.1 (Compliance)" },
            { value: "SOP Alignment (5.3)", label: "5.3 (SOP)" },
            { value: "Cross-BU Synergy (6.1)", label: "6.1 (Synergy)" },
            { value: "IBC Collaboration (6.5)", label: "6.5 (IBC)" },
            { value: "N/A", label: "N/A" }
        ];

        // ========== UTILITY FUNCTIONS ========== 

        /**
         * Show toast notification
         * @param {string} message
         * @param {string} type - 'success' | 'error' | 'info' | 'warning'
         */
        function showToast(message, type = 'success') {
            try {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.textContent = sanitizeText(message);
                toast.setAttribute('role', 'alert');
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.style.animation = 'slideOut 0.3s ease-in forwards';
                    setTimeout(() => {
                        if (toast.parentNode) toast.remove();
                    }, 300);
                }, 3000);
            } catch (error) {
                console.error('Error showing toast:', error);
            }
        }

        /**
         * Sanitize text to prevent XSS
         */
        function sanitizeText(text) {
            const div = document.createElement('div');
            div.textContent = String(text);
            return div.innerHTML;
        }

        /**
         * Validate email
         */
        function validateEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }

        /**
         * Debounce function
         */
        let searchTimeout;
        function debounce(func, wait) {
            return function(...args) {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => func(...args), wait);
            };
        }

        /**
         * Compress image
         */
        function compressImage(file) {
            return new Promise((resolve, reject) => {
                // Check file size
                if (file.size > APP_CONFIG.maxImageSize) {
                    reject(new Error('File size exceeds limit'));
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        let width = img.width;
                        let height = img.height;

                        // Resize if needed
                        if (width > height) {
                            if (width > 1200) {
                                height *= 1200 / width;
                                width = 1200;
                            }
                        } else {
                            if (height > 1200) {
                                width *= 1200 / height;
                                height = 1200;
                            }
                        }

                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', APP_CONFIG.imageCompressionQuality));
                    };
                    img.onerror = () => reject(new Error('Image load failed'));
                    img.src = e.target.result;
                };
                reader.onerror = () => reject(new Error('File read failed'));
                reader.readAsDataURL(file);
            });
        }

        // ========== AUTH FUNCTIONS ========== 

        window.handleLogin = async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail')?.value?.trim();
            const password = document.getElementById('loginPassword')?.value;
            const btn = document.getElementById('loginBtn');
            const errorEl = document.getElementById('loginError');

            if (!email || !password) {
                errorEl.innerText = "Please fill in all fields";
                errorEl.classList.remove('hidden');
                return;
            }

            if (!validateEmail(email)) {
                errorEl.innerText = "Invalid email format";
                errorEl.classList.remove('hidden');
                return;
            }

            if (password.length < 6) {
                errorEl.innerText = "Password must be at least 6 characters";
                errorEl.classList.remove('hidden');
                return;
            }

            btn.disabled = true;
            btn.setAttribute('aria-busy', 'true');

            try {
                // Auth logic here
                showToast('Login successful!', 'success');
            } catch (error) {
                console.error('Login error:', error);
                errorEl.innerText = error.message || "Login failed";
                errorEl.classList.remove('hidden');
                showToast('Login failed', 'error');
            } finally {
                btn.disabled = false;
                btn.setAttribute('aria-busy', 'false');
            }
        };

        window.handleGuestLogin = async () => {
            const btn = document.getElementById('guestBtn');
            btn.disabled = true;
            try {
                // Guest login logic
                showToast('Guest mode activated', 'info');
            } catch (error) {
                console.error('Guest login error:', error);
                showToast('Error: Unable to enter guest mode', 'error');
            } finally {
                btn.disabled = false;
            }
        };

        window.handleLogout = async () => {
            try {
                // Logout logic
                showToast('Logged out successfully', 'success');
            } catch (error) {
                console.error('Logout error:', error);
                showToast('Error logging out', 'error');
            }
        };

        // ========== PLACEHOLDER FUNCTIONS ========== 
        window.openAddTaskModal = () => showToast('Add task modal', 'info');
        window.closeAddTaskModal = () => showToast('Modal closed', 'info');
        window.handleSaveTask = () => showToast('Task saved!', 'success');
        window.switchView = (v) => console.log('Switched to:', v);
        window.liveSearchTasks = debounce(() => console.log('Searching...'), APP_CONFIG.searchDebounce);
        window.filterTasks = (f) => console.log('Filter:', f);
        window.loadMonth = (idx) => console.log('Month:', idx);
        window.renderSidebar = () => console.log('Rendering sidebar');
        window.renderFilters = () => console.log('Rendering filters');
        window.renderTasks = () => console.log('Rendering tasks');
        window.renderDashboard = () => console.log('Rendering dashboard');

        console.log('%c✅ Application initialized successfully', 'color: green; font-weight: bold;');
    </script>
</body>
</html>
