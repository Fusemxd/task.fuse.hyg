<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Production Planner 2025 (Graphic & Video)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@200;300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Kanit', sans-serif; background-color: #f0f9ff; color: #334155; -webkit-tap-highlight-color: transparent; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Status Colors */
        .status-todo { background-color: #f1f5f9; color: #64748b; border: 1px solid #e2e8f0; }
        .status-doing { background-color: #eff6ff; color: #3b82f6; border: 1px solid #dbeafe; }
        .status-draft { background-color: #f5f3ff; color: #8b5cf6; border: 1px solid #ede9fe; }
        .status-done { background-color: #ecfdf5; color: #10b981; border: 1px solid #d1fae5; }

        /* Department Theme Colors */
        /* Used for non-JS controlled elements like the body class, although JS handles most of the colors now */
        .theme-graphic { --main-color-light: #0ea5e9; --main-color-dark: #0369a1; } /* Sky Blue */
        .theme-video { --main-color-light: #f43f5e; --main-color-dark: #c20e2e; } /* Rose Red */
        
        .nav-btn.active { 
            background-color: var(--active-bg, #0ea5e9); 
            color: white; 
            font-weight: 500; 
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); 
            border: 1px solid var(--active-bg, #0ea5e9);
        }
        .modal-backdrop { background-color: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); }
    </style>
</head>
<body class="min-h-screen flex flex-col pb-20 lg:pb-0 theme-graphic" id="mainBody">

    <!-- LOGIN OVERLAY -->
    <div id="loginOverlay" class="fixed inset-0 z-[60] bg-slate-900 flex items-center justify-center fade-in p-4 overflow-y-auto">
        <div class="bg-white p-6 md:p-8 rounded-2xl shadow-2xl w-full max-w-sm my-auto">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-gradient-to-br from-slate-700 to-slate-900 rounded-xl mx-auto flex items-center justify-center text-white text-2xl font-bold shadow-lg mb-4">P</div>
                <h2 class="text-2xl font-bold text-slate-800">Production Planner</h2>
                <p class="text-slate-500 text-sm">Graphic & Video Team</p>
            </div>
            
            <form onsubmit="handleLogin(event)" class="space-y-4">
                <input type="email" id="loginEmail" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-slate-500" placeholder="name@company.com">
                <input type="password" id="loginPassword" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-slate-500" placeholder="••••••••">
                <div id="loginError" class="text-red-500 text-xs text-center hidden bg-red-50 p-2 rounded border border-red-100"></div>
                <button type="submit" id="loginBtn" class="w-full py-2.5 bg-slate-800 text-white rounded-lg hover:bg-slate-900 transition font-bold shadow-lg flex justify-center items-center gap-2">
                    <span>Login (Full Access)</span>
                </button>
            </form>

            <div class="relative my-6">
                <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-slate-200"></div></div>
                <div class="relative flex justify-center text-xs"><span class="px-2 bg-white text-slate-400">หรือ</span></div>
            </div>

            <button onclick="handleGuestLogin()" id="guestBtn" class="w-full py-2.5 bg-slate-100 text-slate-600 rounded-lg hover:bg-slate-200 transition font-medium text-sm flex justify-center items-center gap-2 border border-slate-200">
                <i class="fa-solid fa-eye"></i> <span>เข้าดูงานเท่านั้น (Guest Mode)</span>
            </button>
        </div>
    </div>

    <!-- Navbar -->
    <nav class="bg-white shadow-sm sticky top-0 z-30 border-b border-gray-100">
        <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <!-- Team Switcher -->
                <div class="relative group">
                    <button id="deptTrigger" class="flex items-center gap-2 bg-slate-50 hover:bg-slate-100 px-3 py-1.5 rounded-lg border border-slate-200 transition">
                        <div id="deptIcon" class="w-6 h-6 rounded flex items-center justify-center text-white text-xs bg-sky-500"><i class="fa-solid fa-palette"></i></div>
                        <div class="text-left hidden sm:block">
                            <div id="deptName" class="text-xs font-bold text-slate-700">Graphic Team</div>
                            <div class="text-[9px] text-slate-400">แตะเพื่อเปลี่ยนทีม</div>
                        </div>
                        <i class="fa-solid fa-chevron-down text-slate-400 text-xs ml-1"></i>
                    </button>
                    <!-- Dropdown -->
                    <div class="absolute top-full left-0 mt-1 w-48 bg-white rounded-xl shadow-xl border border-slate-100 hidden group-hover:block z-50 overflow-hidden">
                        <div onclick="switchDepartment('Graphic')" class="p-3 hover:bg-sky-50 cursor-pointer flex items-center gap-3 border-b border-slate-50">
                            <div class="w-8 h-8 rounded-lg bg-sky-500 text-white flex items-center justify-center"><i class="fa-solid fa-palette"></i></div>
                            <div>
                                <div class="text-xs font-bold text-slate-700">Graphic Team</div>
                                <div class="text-[10px] text-slate-400">งานภาพ/แบนเนอร์</div>
                            </div>
                        </div>
                        <div onclick="switchDepartment('Video')" class="p-3 hover:bg-rose-50 cursor-pointer flex items-center gap-3">
                            <div class="w-8 h-8 rounded-lg bg-rose-500 text-white flex items-center justify-center"><i class="fa-solid fa-video"></i></div>
                            <div>
                                <div class="text-xs font-bold text-slate-700">Video Editor</div>
                                <div class="text-[10px] text-slate-400">งานตัดต่อ/คลิป</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="h-8 w-px bg-slate-200 mx-1"></div>

                <div class="flex flex-col justify-center">
                    <h1 class="text-sm md:text-lg font-bold leading-none text-slate-800 tracking-tight">Production <span class="text-slate-400 font-light">Planner</span></h1>
                    <p class="text-[10px] text-slate-400 flex items-center gap-1 mt-0.5">
                        <i class="fa-solid fa-user-circle"></i> <span id="userEmailDisplay" class="truncate max-w-[100px]">Guest</span>
                    </p>
                </div>
            </div>
            
            <div class="flex items-center gap-2">
                <button onclick="switchView('planner')" id="tab-planner" class="nav-btn active px-3 py-1.5 rounded-lg text-xs md:text-sm transition flex items-center gap-2">
                    <i class="fa-solid fa-calendar-days"></i> <span class="hidden sm:inline">Planner</span>
                </button>
                <button onclick="switchView('dashboard')" id="tab-dashboard" class="nav-btn bg-white text-slate-600 border border-slate-200 hover:bg-slate-50 px-3 py-1.5 rounded-lg text-xs md:text-sm transition flex items-center gap-2">
                    <i class="fa-solid fa-chart-pie"></i> <span class="hidden sm:inline">Status</span>
                </button>
                <button onclick="handleLogout()" id="logoutBtn" class="ml-2 text-slate-300 hover:text-red-500 transition px-2 hidden">
                    <i class="fa-solid fa-power-off"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-grow max-w-7xl mx-auto px-2 md:px-4 py-4 w-full relative">
        <div id="loadingOverlay" class="absolute inset-0 bg-white/90 z-40 hidden flex items-center justify-center backdrop-blur-sm rounded-xl min-h-[50vh]">
            <div class="text-center p-6">
                <i class="fa-solid fa-circle-notch fa-spin text-4xl text-slate-300 mb-2"></i>
                <p class="text-sm text-slate-500">Syncing Data...</p>
            </div>
        </div>

        <!-- VIEW 1: PLANNER -->
        <div id="view-planner" class="grid grid-cols-1 lg:grid-cols-12 gap-4 md:gap-6 fade-in">
            <!-- Mobile Month Nav -->
            <div class="lg:hidden col-span-1 bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden sticky top-0 z-20">
                <div class="flex overflow-x-auto no-scrollbar p-2 gap-2" id="mobileMonthNavigator"></div>
            </div>

            <!-- Desktop Sidebar -->
            <aside class="hidden lg:block lg:col-span-3 space-y-4">
                <div class="bg-white rounded-xl shadow-sm p-4 border border-slate-100 sticky top-20">
                    <div class="flex justify-between items-center mb-3 pb-2 border-b border-slate-100">
                        <span class="text-xs font-bold text-slate-500 uppercase">เดือน</span>
                        <span class="text-[10px] bg-slate-100 px-2 py-0.5 rounded text-slate-500">งาน</span>
                    </div>
                    <div class="space-y-1" id="monthNavigator"></div>
                </div>
            </aside>

            <section class="lg:col-span-9 space-y-4 md:space-y-6">
                <!-- Header Card -->
                <div id="headerCard" class="bg-gradient-to-r from-sky-500 to-blue-600 text-white rounded-xl p-5 md:p-6 shadow-lg flex justify-between items-center relative overflow-hidden transition-colors duration-500">
                    <div class="relative z-10">
                        <div class="flex items-baseline gap-2 md:gap-3">
                            <span class="text-xs md:text-sm opacity-80 font-light">Working In:</span>
                            <h2 class="text-2xl md:text-3xl font-bold" id="currentMonthTitle">มกราคม</h2>
                        </div>
                        <div class="flex items-baseline gap-2 md:gap-3 mt-1">
                            <span class="text-xs md:text-sm opacity-80 font-light">Launch:</span>
                            <h2 class="text-lg md:text-xl font-semibold text-white" id="launchMonthTitle">กุมภาพันธ์</h2>
                        </div>
                    </div>
                    <!-- Guest Mode Badge -->
                    <div id="guestBadge" class="hidden absolute top-4 right-4 bg-black/20 px-3 py-1 rounded-full text-xs font-medium border border-white/20 backdrop-blur-sm">
                        <i class="fa-solid fa-eye mr-1"></i> View Only
                    </div>
                    <i class="fa-solid fa-calendar-check absolute -right-6 -bottom-6 text-8xl md:text-9xl text-white opacity-10"></i>
                </div>

                <!-- Filters & Add Button -->
                <div class="flex flex-col sm:flex-row items-stretch sm:items-center justify-between gap-3">
                    <div class="flex gap-2 overflow-x-auto no-scrollbar pb-1 sm:pb-0" id="filterContainer">
                        <button class="filter-btn active whitespace-nowrap px-3 py-1.5 text-xs md:text-sm rounded-lg bg-slate-700 text-white font-medium transition" onclick="filterTasks('all', this)">งานทั้งหมด</button>
                        <!-- Dynamic Filters will be injected here -->
                    </div>
                    
                    <button id="addTaskBtn" onclick="openAddTaskModal()" class="hidden flex justify-center items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-green-500 hover:bg-green-600 rounded-lg shadow-sm shadow-green-200 transition transform active:scale-95 w-full sm:w-auto">
                        <i class="fa-solid fa-plus"></i> เพิ่มงานใหม่
                    </button>
                </div>

                <div id="taskList" class="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-4 pb-20 lg:pb-0"></div>
            </section>
        </div>

        <!-- VIEW 2: DASHBOARD (Updated to include charts and tables) -->
        <div id="view-dashboard" class="hidden fade-in space-y-6 pb-20 lg:pb-0">
            <h3 id="dashboardTitle" class="text-2xl font-bold text-slate-800">Dashboard: Graphic Team</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 col-span-2">
                    <h4 class="font-bold text-slate-800 mb-4 text-lg">ภาพรวมงานรายเดือน (Monthly Completion)</h4>
                    <div class="h-64"><canvas id="monthlyChart"></canvas></div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 space-y-6">
                    <h4 class="font-bold text-slate-800 text-lg">สถานะปัจจุบัน (Current Status)</h4>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center p-3 bg-slate-50 rounded-lg border border-slate-100">
                            <span class="text-slate-600"><i class="fa-solid fa-circle text-slate-400 mr-2"></i>รอดำเนินการ</span>
                            <span class="font-bold text-lg text-slate-700" id="stat-todo">0</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-blue-50 rounded-lg border border-blue-100">
                            <span class="text-blue-700"><i class="fa-solid fa-spinner text-blue-500 mr-2"></i>กำลังทำ</span>
                            <span class="font-bold text-lg text-blue-700" id="stat-doing">0</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-purple-50 rounded-lg border border-purple-100">
                            <span class="text-purple-700"><i class="fa-solid fa-clock text-purple-500 mr-2"></i>รอรีวิว</span>
                            <span class="font-bold text-lg text-purple-700" id="stat-draft">0</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-green-50 rounded-lg border border-green-100">
                            <span class="text-green-700"><i class="fa-solid fa-check-circle text-green-500 mr-2"></i>เสร็จสิ้น</span>
                            <span class="font-bold text-lg text-green-700" id="stat-done">0</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                    <div>
                        <h4 class="font-bold text-slate-700">รายละเอียดความคืบหน้า (Progress Details)</h4>
                        <p class="text-xs text-slate-400 mt-1 font-light">แตะที่เดือนเพื่อดูรายละเอียดงานทั้งหมด</p>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left min-w-[600px]">
                        <thead class="text-xs text-slate-500 uppercase bg-slate-50 border-b border-slate-100">
                            <tr>
                                <th class="px-4 md:px-6 py-3 w-1/4">เดือน</th>
                                <th class="px-4 md:px-6 py-3">งานทั้งหมด</th>
                                <th class="px-4 md:px-6 py-3 w-1/3">ความคืบหน้า</th>
                                <th class="px-4 md:px-6 py-3">%</th>
                                <th class="px-4 md:px-6 py-3 text-right">สถานะ</th>
                            </tr>
                        </thead>
                        <tbody id="dashboardTableBody" class="divide-y divide-slate-100 font-light"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- ADD/EDIT TASK MODAL -->
    <div id="addTaskModal" class="fixed inset-0 z-50 hidden flex items-center justify-center modal-backdrop fade-in p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden border border-slate-100 max-h-[90vh] flex flex-col">
            <div class="px-6 py-4 bg-slate-50 border-b border-slate-100 flex justify-between items-center shrink-0">
                <h3 id="modalTitle" class="font-bold text-lg text-slate-800">เพิ่มงานใหม่</h3>
                <button onclick="closeAddTaskModal()" class="text-slate-400 hover:text-red-500 transition"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="p-6 space-y-4 overflow-y-auto">
                <input type="hidden" id="editingTaskId">
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">เดือน (Month)</label>
                        <select id="newTaskMonth" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm bg-white"></select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">กำหนดส่ง (Due Date)</label>
                        <input type="date" id="newTaskDueDate" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm text-slate-600 focus:outline-none focus:ring-2 focus:ring-sky-500">
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">ชื่องาน <span class="text-red-500">*</span></label>
                    <input type="text" id="newTaskTitle" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="ชื่องานหลัก...">
                    <p id="titleError" class="text-red-500 text-xs hidden mt-1">กรุณากรอกชื่องาน</p>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">รายละเอียด</label>
                    <textarea id="newTaskDesc" rows="2" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="รายละเอียดเพิ่มเติม..."></textarea>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">ประเภทงาน</label>
                        <select id="newTaskChannel" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm bg-white">
                            <!-- JS Will Populate based on Team -->
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">ความสำคัญ</label>
                        <select id="newTaskPriority" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm bg-white">
                            <option value="C">Critical (C - ด่วน/สำคัญ)</option>
                            <option value="S" selected>Support (S - งานรอง/ทั่วไป)</option>
                        </select>
                    </div>
                </div>
                 <!-- NEW KPI INPUT FIELD -->
                 <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">KPI Reference</label>
                    <select id="newTaskKPI" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm bg-white">
                        <!-- KPI options will be injected by JavaScript -->
                    </select>
                </div>
            </div>
            <div class="px-6 py-4 bg-slate-50 border-t border-slate-100 flex justify-end gap-2 shrink-0">
                <button onclick="closeAddTaskModal()" class="px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-200 rounded-lg transition">ยกเลิก</button>
                <button onclick="handleSaveTask()" id="saveTaskBtn" class="px-4 py-2 text-sm font-medium text-white bg-sky-500 hover:bg-sky-600 rounded-lg shadow-sm transition">บันทึก</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signInAnonymously, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Config (Replace with Canvas variables if available, otherwise use defaults)
        const firebaseConfig = {
            apiKey: "AIzaSyBdmGg7vi9QAD04TFM9suKvjoId_HO7s18",
            authDomain: "fusetaskhyg.firebaseapp.com",
            projectId: "fusetaskhyg",
            storageBucket: "fusetaskhyg.firebasestorage.app",
            messagingSenderId: "667329598644",
            appId: "1:667329598644:web:79abb5f6a20739d14f73e1"
        };
        const appId = 'graphic-planner-default';
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // State
        let currentUser = null;
        let isGuest = false;
        let currentDepartment = 'Graphic'; // 'Graphic' or 'Video'
        let scheduleData = Array.from({length: 12}, () => []);
        let currentMonth = 0;
        let activeFilter = 'all';
        let chartInstance = null; // Global chart instance for dashboard
        let openDropdownId = null; // Global state for one-at-a-time dropdowns

        // Constants (Updated to use only Thai names)
        const MONTH_NAMES_TH = ["มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน", "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"];
        // เดือนที่งานจะถูก Launch (คือเดือนถัดไป)
        const LAUNCH_MONTHS_TH = ["กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน", "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม", "มกราคม (ปีหน้า)"];

        const themeDB = {
            1: { double: "New Year New You", mid: "Start Fresh Deals", payday: "Payday รับตรุษจีน" },
            2: { double: "Double Love Deal", mid: "Sweet Valentine", payday: "Payday คนมีคู่" },
            3: { double: "Summer Hot Sale", mid: "Hot Deal ท้าแดด", payday: "Payday คลายร้อน" },
            4: { double: "Songkran Mega Sale", mid: "สาดโปร ชุ่มฉ่ำ", payday: "Payday หลังสงกรานต์" },
            5: { double: "Back to School", mid: "Rainy Season Prep", payday: "Payday ท้าฝน" },
            6: { double: "Mid-Year Mega Sale", mid: "Mid-Year Bonus", payday: "Payday ช้อปกลางปี" },
            7: { double: "Healthy July", mid: "Health Boost Deal", payday: "Payday สุขภาพดี" },
            8: { double: "Mother's Day Special", mid: "Love Mom Deal", payday: "Payday เพื่อแม่" },
            9: { double: "9.9 Super Shopping", mid: "After Party 9.9", payday: "Payday ปลายฝน" },
            10: { double: "10.10 Brand Festival", mid: "Big Brands Sale", payday: "Payday เตรียมหนาว" },
            11: { double: "11.11 Biggest Sale", mid: "Shock Price Deal", payday: "Payday ก่อนปีใหม่" },
            12: { double: "12.12 Year End Sale", mid: "Gift Festival", payday: "Payday ฉลองปีใหม่" }
        };

        const graphicChannels = ["Online Platform", "Social Media", "Offline/Print", "Internal"];
        const videoChannels = ["Short Video (Tiktok/Reels)", "Youtube Long Form", "Ads Video", "Internal Clip"];
        
        const STATUS_CONFIG = {
            'todo': { label: 'รอดำเนินการ', colorClass: 'status-todo', icon: 'fa-circle' },
            'doing': { label: 'กำลังทำ', colorClass: 'status-doing', icon: 'fa-spinner fa-spin' },
            'draft': { label: 'รอรีวิว', colorClass: 'status-draft', icon: 'fa-eye' },
            'done': { label: 'เสร็จสิ้น', colorClass: 'status-done', icon: 'fa-check-circle' }
        };
        
        const KPI_OPTIONS = [
            { value: "Financials (1.1)", label: "1.1 (P&L, Cash Flow)" },
            { value: "Profitability (1.2)", label: "1.2 (Product Profitability)" },
            { value: "Reforecasting (1.3)", label: "1.3 (Reforecasting/Budget)" },
            { value: "Pricing/Cost (1.4)", label: "1.4 (Pricing/Cost Strategy)" },
            { value: "Margin/Cost (1.5)", label: "1.5 (Margin/Cost Reduction)" },
            { value: "New Products (1.6)", label: "1.6 (New Product Revenue)" },
            { value: "Customer Exp (2.1)", label: "2.1 (Customer Experience)" },
            { value: "Retention/Loyalty (2.2)", label: "2.2 (Retention/Loyalty)" },
            { value: "Market Presence (2.3)", label: "2.3 (Market Presence)" },
            { value: "Non-Compliance (5.1)", label: "5.1 (Zero Non-Compliance)" },
            { value: "SOP Alignment (5.3)", label: "5.3 (SOP Alignment)" },
            { value: "Cross-BU Synergy (6.1)", label: "6.1 (Cross-BU Synergy)" },
            { value: "IBC Collaboration (6.5)", label: "6.5 (IBC Collaboration)" },
            { value: "N/A", label: "N/A" }
        ];


        // --- Auth Functions ---
        window.handleLogin = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('loginBtn');
            const err = document.getElementById('loginError');
            btn.disabled = true; btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Checking...';
            try {
                // NOTE: Use environment-provided token for auth in production, but allowing direct login for demo
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                await signInWithEmailAndPassword(auth, email, password);
            } catch (e) {
                err.innerText = "Email หรือ Password ผิด";
                if(e.code === 'auth/operation-not-allowed') err.innerText = "Error: เปิด Email Auth ใน Console ก่อน";
                err.classList.remove('hidden');
                btn.disabled = false; btn.innerHTML = 'Login';
            }
        };

        window.handleGuestLogin = async () => {
            const btn = document.getElementById('guestBtn');
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> กำลังเข้า...';
            try { await signInAnonymously(auth); } 
            catch (e) { console.error("Guest Login Error:", e.message); alert("Guest Login Error: " + e.message); btn.innerHTML = 'Try Guest Again'; }
        };

        window.handleLogout = async () => await signOut(auth);

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                isGuest = user.isAnonymous;
                document.getElementById('loginOverlay').classList.add('hidden');
                document.getElementById('logoutBtn').classList.remove('hidden');
                document.getElementById('userEmailDisplay').innerText = isGuest ? 'Guest User' : user.email;
                
                // Show/Hide Add Button based on Guest
                if(isGuest) {
                    document.getElementById('addTaskBtn').classList.add('hidden');
                    document.getElementById('guestBadge').classList.remove('hidden');
                } else {
                    document.getElementById('addTaskBtn').classList.remove('hidden');
                    document.getElementById('guestBadge').classList.add('hidden');
                }

                // Initial setup or re-setup after login
                setupRealtimeListener();
                // Ensure the initial department state is applied (Graphic by default)
                switchDepartment(currentDepartment, false); // false = don't reset filter
            } else {
                document.getElementById('loginOverlay').classList.remove('hidden');
                document.getElementById('logoutBtn').classList.add('hidden');
                document.getElementById('loginBtn').innerHTML = 'Login';
                document.getElementById('loginBtn').disabled = false;
            }
        });

        // --- Core Logic ---
        function setupRealtimeListener() {
            // Check if listener is already active (to prevent multiple listeners after re-auth)
            // In this simple app, we rely on onSnapshot implicitly handling updates, but a more robust app would track listeners.
            const tasksRef = collection(db, 'artifacts', appId, 'public', 'data', 'tasks');
            onSnapshot(query(tasksRef), (snapshot) => {
                // Check seed (v9 to force update to ensure KPI mapping and correct language settings are applied)
                if(snapshot.empty && !localStorage.getItem('seeded_v9')) {
                    seedInitialData(tasksRef);
                    localStorage.setItem('seeded_v9', 'true');
                    return; 
                }
                
                scheduleData = Array.from({length: 12}, () => []);
                snapshot.forEach((doc) => {
                    const t = { id: doc.id, ...doc.data() };
                    // Default department to Graphic if missing (Backward Compatibility)
                    if(!t.department) t.department = 'Graphic';
                    
                    if(t.monthIndex >= 0 && t.monthIndex < 12) {
                        scheduleData[t.monthIndex].push(t);
                    }
                });
                refreshView();
                document.getElementById('loadingOverlay').classList.add('hidden');
            });
        }

        async function seedInitialData(ref) {
            console.log("Seeding Full Data (Updated Priority & KPI)...");
            
            for (let i = 0; i < 12; i++) {
                let targetNum = i + 2; if (targetNum > 12) targetNum = 1;
                const targetName = LAUNCH_MONTHS_TH[i];
                const doubleDigit = `${targetNum}.${targetNum}`;
                const themes = themeDB[targetNum] || { double: "Campaign", mid: "MidMonth", payday: "Payday" };

                // --- GRAPHIC TASKS ---
                const graphicTasks = [
                    // Main KV
                    { 
                        title: `Main Key Visual: ${doubleDigit} ${themes.double}`, 
                        desc: `ออกแบบ KV หลักสำหรับแคมเปญ ${doubleDigit} (FB Cover, Line OA, Website Banner)`, 
                        channel: "Online Platform", 
                        priority: "C", 
                        status: "doing", 
                        department: "Graphic",
                        kpi: "Financials (1.1)", 
                        dueDate: new Date(2025, i, 5).toISOString().split('T')[0]
                    },
                    // Banner Sets
                    { 
                        title: `Banner Sets: Mid-Month Sale (${targetName})`, 
                        desc: "ภาพโปรโมชั่นกลางเดือน 15+ SKU สินค้าขายดี", 
                        channel: "Online Platform", 
                        priority: "C", 
                        status: "todo", 
                        department: "Graphic",
                        kpi: "Profitability (1.2)", 
                        dueDate: new Date(2025, i, 12).toISOString().split('T')[0]
                    },
                    { 
                        title: `Banner Sets: Payday Sale (${targetName})`, 
                        desc: "ภาพโปรโมชั่นสิ้นเดือน (เงินเดือนออก) เน้นจัดเซตคุ้มค่า", 
                        channel: "Online Platform", 
                        priority: "C", 
                        status: "todo", 
                        department: "Graphic",
                        kpi: "Financials (1.1)", 
                        dueDate: new Date(2025, i, 25).toISOString().split('T')[0]
                    },
                    // Social Content 
                    { 
                        title: `Social Content: ${themes.double} Teaser`, 
                        desc: "Album Post (4+1) เล่าสตอรี่แคมเปญ + โปรโมชั่น Early Bird", 
                        channel: "Social Media", 
                        priority: "S", 
                        status: "draft", 
                        department: "Graphic",
                        kpi: "Customer Exp (2.1)", 
                        dueDate: new Date(2025, i, 1).toISOString().split('T')[0]
                    },
                    { 
                        title: `Review Content: Customer Feedback`, 
                        desc: "รวมรีวิวลูกค้า (แคปแชท/รูปรีวิว) ลง FB/IG Story", 
                        channel: "Social Media", 
                        priority: "S", 
                        status: "done", 
                        department: "Graphic",
                        kpi: "Market Presence (2.3)", 
                        dueDate: new Date(2025, i, 15).toISOString().split('T')[0]
                    },
                    // Internal 
                    { 
                        title: `Internal: Monthly Newsletter (${targetName})`, 
                        desc: "จดหมายข่าวอัปเดตกิจกรรมภายในบริษัท ส่งทางอีเมล", 
                        channel: "Internal", 
                        priority: "S", 
                        status: "todo", 
                        department: "Graphic",
                        kpi: "IBC Collaboration (6.5)", 
                        dueDate: new Date(2025, i, 28).toISOString().split('T')[0]
                    }
                ];

                // --- VIDEO TASKS ---
                const videoTasks = [
                    {
                        title: `Shorts: ${doubleDigit} Unboxing (ตัดต่อ)`,
                        desc: "คลิปสั้นแกะกล่องสินค้าไฮไลท์ประจำแคมเปญ (Vertical 9:16) - ตัดต่อ",
                        channel: "Short Video (Tiktok/Reels)",
                        priority: "C", 
                        status: "todo",
                        department: "Video",
                        kpi: "Financials (1.1)", 
                        dueDate: new Date(2025, i, 3).toISOString().split('T')[0]
                    },
                    {
                        title: `Reels: บรรยากาศแคมเปญ ${themes.double} (ตัดต่อ)`,
                        desc: "คลิปบรรยากาศ/เบื้องหลัง หรือ Mood & Tone สินค้า - ตัดต่อ",
                        channel: "Short Video (Tiktok/Reels)",
                        priority: "S", 
                        status: "todo",
                        department: "Video",
                        kpi: "Customer Exp (2.1)", 
                        dueDate: new Date(2025, i, 10).toISOString().split('T')[0]
                    }
                ];

                const allTasks = [...graphicTasks, ...videoTasks];

                for (const t of allTasks) {
                    await addDoc(ref, {
                        ...t,
                        campaignTheme: themes.double || "General",
                        monthIndex: i,
                        createdAt: new Date().toISOString()
                    });
                }
            }
        }

        window.switchDepartment = function(dept, resetFilter = true) {
            if(dept !== 'Graphic' && dept !== 'Video') return;
            currentDepartment = dept;
            
            // 1. Update Body Theme Class
            document.getElementById('mainBody').className = `min-h-screen flex flex-col pb-20 lg:pb-0 theme-${dept.toLowerCase()}`;
            
            // 2. Set Theme Variables & UI Labels
            const themeColor = dept === 'Graphic' ? '#0ea5e9' : '#f43f5e';
            const colorClass = dept === 'Graphic' ? 'bg-sky-500' : 'bg-rose-500';
            const iconClass = dept === 'Graphic' ? 'fa-palette' : 'fa-video';
            const gradientClass = dept === 'Graphic' ? 'from-sky-500 to-blue-600' : 'from-rose-500 to-pink-600';
            const btnClass = dept === 'Graphic' ? 'bg-sky-500 hover:bg-sky-600' : 'bg-rose-500 hover:bg-rose-600';

            document.documentElement.style.setProperty('--active-bg', themeColor);
            
            document.getElementById('deptName').innerText = dept === 'Graphic' ? 'Graphic Team' : 'Video Editor';
            document.getElementById('deptIcon').className = `w-6 h-6 rounded flex items-center justify-center text-white text-xs ${colorClass}`;
            document.getElementById('deptIcon').innerHTML = `<i class="fa-solid ${iconClass}"></i>`;
            document.getElementById('headerCard').className = `bg-gradient-to-r ${gradientClass} text-white rounded-xl p-5 md:p-6 shadow-lg flex justify-between items-center relative overflow-hidden transition-colors duration-500`;
            document.getElementById('saveTaskBtn').className = `px-4 py-2 text-sm font-medium text-white rounded-lg shadow-sm transition ${btnClass}`;
            
            // 3. Reset Filter if requested and Refresh View
            if(resetFilter) activeFilter = 'all';
            refreshView();
        }

        function refreshView() {
            renderSidebar();
            renderFilters();
            renderTasks();
            // Render dashboard only if it's the active view
            if(!document.getElementById('view-dashboard').classList.contains('hidden')) {
                renderDashboard();
            }
        }

        window.loadMonth = function(idx) {
            currentMonth = idx;
            document.getElementById('currentMonthTitle').innerText = MONTH_NAMES_TH[idx];
            document.getElementById('launchMonthTitle').innerText = LAUNCH_MONTHS_TH[idx];
            refreshView();
        }

        window.renderSidebar = function() {
            const container = document.getElementById('monthNavigator');
            const mobileContainer = document.getElementById('mobileMonthNavigator');
            
            // Check active team color
            const activeColor = currentDepartment === 'Graphic' ? 'sky' : 'rose';
            const activeClass = `bg-${activeColor}-100 text-${activeColor}-600 border-${activeColor}-200`;
            
            const html = MONTH_NAMES_TH.map((m, i) => {
                // Filter count by current Department
                const count = scheduleData[i].filter(t => t.department === currentDepartment).length;
                const isActive = i === currentMonth;
                const activeStyle = isActive ? `${activeClass} font-bold` : 'hover:bg-slate-50 text-slate-600';
                
                return `<button onclick="loadMonth(${i})" class="nav-btn w-full text-left px-3 py-2 rounded-lg flex justify-between items-center text-sm transition-all ${activeStyle}">
                    <span>${m}</span>
                    <span class="text-[10px] bg-white border border-slate-100 px-2 py-0.5 rounded-full text-slate-400 w-6 text-center">${count}</span>
                </button>`;
            }).join('');
            
            container.innerHTML = html;

            // Mobile
            mobileContainer.innerHTML = MONTH_NAMES_TH.map((m, i) => {
                const count = scheduleData[i].filter(t => t.department === currentDepartment).length;
                const isActive = i === currentMonth;
                const activeStyle = isActive ? `bg-${activeColor}-600 text-white border-${activeColor}-600` : 'bg-white text-slate-600 border-slate-200';
                return `<button onclick="loadMonth(${i})" class="shrink-0 px-3 py-1.5 rounded-lg border text-xs flex items-center gap-2 transition-all ${activeStyle}">
                    <span>${m}</span>
                    <span class="text-[9px] bg-white/20 px-1.5 rounded-full ${isActive?'text-white':'text-slate-400'}">${count}</span>
                </button>`;
            }).join('');
            
            // Scroll mobile nav
            mobileContainer.children[currentMonth]?.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
        }

        window.renderFilters = function() {
            const container = document.getElementById('filterContainer');
            const channels = currentDepartment === 'Graphic' ? graphicChannels : videoChannels;
            
            let html = `<button class="filter-btn whitespace-nowrap px-3 py-1.5 text-xs md:text-sm rounded-lg ${activeFilter==='all' ? 'bg-slate-700 text-white' : 'bg-white text-slate-600 border border-slate-200'} transition" onclick="filterTasks('all')">งานทั้งหมด</button>`;
            
            channels.forEach(c => {
                const isActive = activeFilter === c;
                const themeColor = currentDepartment === 'Graphic' ? 'sky' : 'rose';
                const activeClass = `bg-${themeColor}-600 text-white`;
                
                html += `<button class="filter-btn whitespace-nowrap px-3 py-1.5 text-xs md:text-sm rounded-lg transition ${isActive ? activeClass : 'bg-white text-slate-600 border border-slate-200'}" onclick="filterTasks('${c}')">${c.split(' ')[0]}</button>`;
            });
            container.innerHTML = html;
        }

        window.filterTasks = function(f) {
            activeFilter = f;
            renderFilters();
            renderTasks();
        }
        
        // --- Dropdown Click Management ---
        window.toggleStatusDropdown = function(event, dropdownId) {
            event.stopPropagation();
            const dropdown = document.getElementById(dropdownId);
            
            // Close the currently open one, if any (and it's not the current one)
            if (openDropdownId && openDropdownId !== dropdownId) {
                document.getElementById(openDropdownId)?.classList.add('hidden');
            }
            
            // Toggle the current one
            if (dropdown.classList.contains('hidden')) { 
                dropdown.classList.remove('hidden'); 
                openDropdownId = dropdownId; 
            } else { 
                dropdown.classList.add('hidden'); 
                openDropdownId = null; 
            }
        }

        document.addEventListener('click', function(event) {
            if (openDropdownId) {
                const dropdown = document.getElementById(openDropdownId);
                let isOutside = true;
                let target = event.target;
                for(let i=0; i<4; i++) {
                    if (target === dropdown || target.id === openDropdownId.replace('status-dropdown-', 'status-btn-')) {
                        isOutside = false;
                        break;
                    }
                    target = target.parentElement;
                    if (!target) break;
                }

                if (isOutside) {
                    dropdown.classList.add('hidden');
                    openDropdownId = null;
                }
            }
        });
        
        // --- End Dropdown Click Management ---

        window.renderTasks = function() {
            const allTasks = scheduleData[currentMonth].filter(t => t.department === currentDepartment);
            const filtered = activeFilter === 'all' ? allTasks : allTasks.filter(t => t.channel === activeFilter);
            const container = document.getElementById('taskList');
            
            if(filtered.length === 0) {
                container.innerHTML = `<div class="col-span-full py-12 text-center border-2 border-dashed border-slate-200 rounded-xl text-slate-400">
                    <i class="fa-regular fa-folder-open text-2xl mb-2"></i><br>ไม่มีงานในหมวดนี้
                </div>`;
                return;
            }

            container.innerHTML = filtered.map(t => {
                // Status Logic
                const sConf = STATUS_CONFIG[t.status] || STATUS_CONFIG['todo'];
                const dropdownId = `status-dropdown-${t.id}`;
                const buttonId = `status-btn-${t.id}`;

                // Priority Color Logic (Updated for C and S only)
                const priorityColor = t.priority === 'C' ? 'text-red-500' : 'text-slate-400';

                // Actions (Hidden if Guest)
                const actions = isGuest ? '' : `
                    <div class="flex gap-2">
                        <button onclick="openEditTaskModal('${t.id}')" class="text-slate-300 hover:text-sky-500"><i class="fa-solid fa-pen"></i></button>
                        <button onclick="deleteTask('${t.id}')" class="text-slate-300 hover:text-red-500"><i class="fa-solid fa-trash"></i></button>
                    </div>`;
                
                // Status Dropdown (Disabled if Guest) - Changed to explicit click handler
                const statusBtn = isGuest 
                    ? `<span class="px-3 py-1.5 rounded-full text-xs font-bold border flex items-center gap-2 ${sConf.colorClass}"><i class="fa-solid ${sConf.icon}"></i> ${sConf.label}</span>`
                    : `<div class="relative">
                        <button id="${buttonId}" onclick="toggleStatusDropdown(event, '${dropdownId}')" class="px-3 py-1.5 rounded-full text-xs font-bold border flex items-center gap-2 ${sConf.colorClass}">
                            <i class="fa-solid ${sConf.icon}"></i> ${sConf.label} <i class="fa-solid fa-chevron-down opacity-50"></i>
                        </button>
                        <div id="${dropdownId}" class="absolute bottom-full left-0 mb-1 w-32 bg-white shadow-xl rounded-lg border border-slate-100 hidden z-10 overflow-hidden">
                            <div onclick="updateStatus('${t.id}', 'todo'); toggleStatusDropdown(event, '${dropdownId}')" class="p-2 hover:bg-slate-50 cursor-pointer text-xs text-slate-600">${STATUS_CONFIG.todo.label}</div>
                            <div onclick="updateStatus('${t.id}', 'doing'); toggleStatusDropdown(event, '${dropdownId}')" class="p-2 hover:bg-blue-50 cursor-pointer text-xs text-blue-600">${STATUS_CONFIG.doing.label}</div>
                            <div onclick="updateStatus('${t.id}', 'draft'); toggleStatusDropdown(event, '${dropdownId}')" class="p-2 hover:bg-purple-50 cursor-pointer text-xs text-purple-600">${STATUS_CONFIG.draft.label}</div>
                            <div onclick="updateStatus('${t.id}', 'done'); toggleStatusDropdown(event, '${dropdownId}')" class="p-2 hover:bg-green-50 cursor-pointer text-xs text-green-600">${STATUS_CONFIG.done.label}</div>
                        </div>
                       </div>`;

                // Date Display
                const dateDisplay = t.dueDate ? 
                    `<span class="text-[10px] text-slate-400 bg-slate-50 px-2 py-0.5 rounded border border-slate-100">
                        <i class="fa-regular fa-clock mr-1"></i>${new Date(t.dueDate).toLocaleDateString('th-TH', {day:'numeric', month:'short'})}
                    </span>` : '';
                
                // KPI Display (Updated to show X.X numerical ID)
                const kpiMatch = t.kpi ? t.kpi.match(/\((.*?)\)/) : null;
                const kpiID = kpiMatch ? kpiMatch[1] : (t.kpi === 'N/A' ? 'N/A' : (t.kpi || 'N/A'));
                
                // --- KPI Tag Display Logic ---
                const kpiDisplay = kpiID && kpiID !== 'N/A' ? 
                    `<span class="text-[10px] text-amber-700 bg-amber-100 px-2 py-0.5 rounded-full border border-amber-300 whitespace-nowrap font-bold">
                        KPI: ${kpiID}
                    </span>` : '';
                // -----------------------------


                return `
                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-100 hover:shadow-md transition relative group border-l-4 ${currentDepartment === 'Graphic' ? 'border-l-sky-500' : 'border-l-rose-500'}">
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-[10px] font-bold uppercase tracking-wider text-slate-400 bg-slate-50 px-2 py-1 rounded">${t.channel}</span>
                        ${actions}
                    </div>
                    <h4 class="font-bold text-slate-800 text-lg leading-tight mb-1">${t.title}</h4>
                    <p class="text-xs text-slate-500 font-light mb-3 line-clamp-2">${t.desc}</p>
                    
                    <div class="flex justify-between items-end border-t border-slate-50 pt-3">
                        ${statusBtn}
                        <div class="flex flex-col items-end gap-1">
                            ${kpiDisplay}
                            ${dateDisplay}
                            <span class="text-[10px] font-bold ${priorityColor}">Priority: ${t.priority}</span>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }
        
        // --- DASHBOARD RENDER ---
        window.renderDashboard = function() {
            // 1. Filter tasks for the current department
            let counts = { todo:0, doing:0, draft:0, done:0 };
            let monthlyProgress = [];
            
            document.getElementById('dashboardTitle').innerText = `Dashboard: ${currentDepartment} Team`;
            const chartColor = currentDepartment === 'Graphic' ? '#0ea5e9' : '#f43f5e';

            scheduleData.forEach((monthTasks, idx) => {
                const deptTasks = monthTasks.filter(t => t.department === currentDepartment);
                
                let mDone = 0;
                deptTasks.forEach(t => {
                    if(counts[t.status] !== undefined) counts[t.status]++;
                    if(t.status === 'done') mDone++;
                });
                let percent = deptTasks.length > 0 ? Math.round((mDone / deptTasks.length) * 100) : 0;
                monthlyProgress.push({ total: deptTasks.length, done: mDone, percent: percent, tasks: deptTasks });
            });

            // 2. Update Status Counts
            document.getElementById('stat-todo').innerText = counts.todo;
            document.getElementById('stat-doing').innerText = counts.doing;
            document.getElementById('stat-draft').innerText = counts.draft;
            document.getElementById('stat-done').innerText = counts.done;

            // 3. Update Table
            const tbody = document.getElementById('dashboardTableBody');
            tbody.innerHTML = MONTH_NAMES_TH.map((m, i) => {
                const data = monthlyProgress[i];
                const total = data.total;
                const pct = data.percent;
                const done = data.done;
                
                let barColor = 'bg-slate-200';
                if(pct > 0) barColor = 'bg-blue-500';
                if(pct === 100) barColor = 'bg-green-500';

                const taskRows = data.tasks.map(t => {
                    const sConf = STATUS_CONFIG[t.status] || STATUS_CONFIG['todo'];
                    
                    return `
                        <div class="flex justify-between items-center p-2.5 hover:bg-white rounded-lg border border-transparent hover:border-slate-200 transition mb-1 last:mb-0">
                            <div class="flex items-center gap-3">
                                <span class="text-[10px] font-bold uppercase text-slate-400 w-16">${t.channel.split(' ')[0]}</span>
                                <span class="text-sm font-medium text-slate-700 truncate max-w-[150px]">${t.title}</span>
                            </div>
                            <span class="text-[10px] px-2 py-0.5 rounded-full ${sConf.colorClass} border flex items-center gap-1 whitespace-nowrap">
                                <i class="fa-solid ${sConf.icon}"></i> ${sConf.label}
                            </span>
                        </div>
                    `;
                }).join('');

                return `
                    <tr class="bg-white border-b border-slate-50 hover:bg-sky-50 cursor-pointer transition-colors" onclick="toggleMonthDetails(${i})">
                        <td class="px-4 md:px-6 py-4 font-medium text-slate-900 flex items-center gap-3">
                            <i id="chevron-${i}" class="fa-solid fa-chevron-right text-slate-400 text-xs transition-transform duration-200"></i>
                            ${m}
                        </td>
                        <td class="px-4 md:px-6 py-4 text-slate-600">${total}</td>
                        <td class="px-4 md:px-6 py-4">
                            <div class="w-full bg-slate-200 rounded-full h-2.5">
                                <div class="${barColor} h-2.5 rounded-full transition-all duration-500" style="width: ${pct}%"></div>
                            </div>
                        </td>
                        <td class="px-4 md:px-6 py-4 font-bold text-slate-700">${pct}%</td>
                        <td class="px-4 md:px-6 py-4 text-right">
                            ${pct === 100 ? '<span class="text-green-600 text-xs font-bold"><i class="fa-solid fa-check mr-1"></i> เสร็จสิ้น</span>' : 
                              pct > 0 ? `<span class="text-blue-600 text-xs font-bold">${done}/${total}</span>` : 
                              '<span class="text-slate-400 text-xs">-</span>'}
                        </td>
                    </tr>
                    <tr id="details-${i}" class="hidden bg-slate-50/50">
                        <td colspan="5" class="px-4 md:px-6 py-4">
                            <div class="pl-2 md:pl-6 border-l-2 border-slate-200 space-y-1">
                                ${data.tasks.length ? taskRows : '<p class="text-sm text-slate-400 italic pl-2">ไม่มีงานในหมวดนี้สำหรับเดือนนี้</p>'}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            // 4. Update Chart
            const chartData = monthlyProgress.map(d => d.percent);
            const ctx = document.getElementById('monthlyChart').getContext('2d');
            if(chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: MONTH_NAMES_TH,
                    datasets: [{
                        label: '% ความคืบหน้า',
                        data: chartData,
                        backgroundColor: chartData.map(p => p === 100 ? '#10b981' : chartColor),
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, max: 100 } },
                    plugins: { legend: { display: false } }
                }
            });
        }
        
        window.toggleMonthDetails = function(idx) {
            const row = document.getElementById(`details-${idx}`);
            const chevron = document.getElementById(`chevron-${idx}`);
            if(row.classList.contains('hidden')) { row.classList.remove('hidden'); chevron.classList.add('rotate-90'); } 
            else { row.classList.add('hidden'); chevron.classList.remove('rotate-90'); }
        }

        // --- CRUD ---
        
        function populateKpiSelect(selectedValue = 'N/A') {
            const kpiSelect = document.getElementById('newTaskKPI');
            // Show full label in the dropdown
            kpiSelect.innerHTML = KPI_OPTIONS.map(opt => 
                `<option value="${opt.value}" ${opt.value === selectedValue ? 'selected' : ''}>${opt.value}</option>`
            ).join('');
        }

        window.openAddTaskModal = function() {
            document.getElementById('editingTaskId').value = '';
            document.getElementById('modalTitle').innerText = 'เพิ่มงานใหม่ (' + currentDepartment + ')';
            document.getElementById('newTaskTitle').value = '';
            document.getElementById('newTaskDesc').value = '';
            document.getElementById('newTaskDueDate').value = '';
            
            // Populate Month
            document.getElementById('newTaskMonth').innerHTML = MONTH_NAMES_TH.map((m,i) => `<option value="${i}" ${i===currentMonth?'selected':''}>${m}</option>`).join('');
            
            // Populate Channels based on Dept
            const chans = currentDepartment === 'Graphic' ? graphicChannels : videoChannels;
            document.getElementById('newTaskChannel').innerHTML = chans.map(c => `<option value="${c}">${c}</option>`).join('');
            
            // Populate KPI (Always set to default 'N/A' for new task)
            populateKpiSelect('N/A');

            // Apply current department color theme to modal button
            const themeColor = currentDepartment === 'Graphic' ? 'sky' : 'rose';
            document.getElementById('newTaskDueDate').className = `w-full border border-slate-200 rounded-lg px-3 py-2 text-sm text-slate-600 focus:outline-none focus:ring-2 focus:ring-${themeColor}-500`;
            document.getElementById('newTaskTitle').className = `w-full border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-${themeColor}-500`;
            document.getElementById('newTaskDesc').className = `w-full border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-${themeColor}-500`;
            document.getElementById('saveTaskBtn').className = `px-4 py-2 text-sm font-medium text-white bg-${themeColor}-500 hover:bg-${themeColor}-600 rounded-lg shadow-sm transition`;

            document.getElementById('addTaskModal').classList.remove('hidden');
        }

        window.openEditTaskModal = function(id) {
            const task = scheduleData.flat().find(t => t.id === id); // Find task globally
            if(!task) return;
            
            // Ensure we switch department if editing a task from another department (shouldn't happen with the current UI)
            if (task.department !== currentDepartment) {
                switchDepartment(task.department, false);
            }

            document.getElementById('editingTaskId').value = id;
            document.getElementById('modalTitle').innerText = 'แก้ไขงาน';
            document.getElementById('newTaskTitle').value = task.title;
            document.getElementById('newTaskDesc').value = task.desc;
            document.getElementById('newTaskDueDate').value = task.dueDate || '';
            
            // Populate Month
            document.getElementById('newTaskMonth').innerHTML = MONTH_NAMES_TH.map((m,i) => `<option value="${i}" ${i===task.monthIndex?'selected':''}>${m}</option>`).join('');
            
            // Populate Channels ensuring current value exists
            const chans = currentDepartment === 'Graphic' ? graphicChannels : videoChannels;
            document.getElementById('newTaskChannel').innerHTML = chans.map(c => `<option value="${c}" ${c===task.channel?'selected':''}>${c}</option>`).join('');
            
            // Populate KPI (Set to existing task's KPI)
            populateKpiSelect(task.kpi || 'N/A');
            
            document.getElementById('newTaskPriority').value = task.priority;

            // Apply current department color theme to modal button
            const themeColor = currentDepartment === 'Graphic' ? 'sky' : 'rose';
            document.getElementById('newTaskDueDate').className = `w-full border border-slate-200 rounded-lg px-3 py-2 text-sm text-slate-600 focus:outline-none focus:ring-2 focus:ring-${themeColor}-500`;
            document.getElementById('newTaskTitle').className = `w-full border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-${themeColor}-500`;
            document.getElementById('newTaskDesc').className = `w-full border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-${themeColor}-500`;
            document.getElementById('saveTaskBtn').className = `px-4 py-2 text-sm font-medium text-white bg-${themeColor}-500 hover:bg-${themeColor}-600 rounded-lg shadow-sm transition`;
            
            document.getElementById('addTaskModal').classList.remove('hidden');
        }

        window.closeAddTaskModal = () => document.getElementById('addTaskModal').classList.add('hidden');

        window.handleSaveTask = async function() {
            const id = document.getElementById('editingTaskId').value;
            const title = document.getElementById('newTaskTitle').value;
            
            if(!title) { 
                document.getElementById('titleError').classList.remove('hidden');
                return; 
            }
            document.getElementById('titleError').classList.add('hidden');
            
            const kpi = document.getElementById('newTaskKPI').value; 

            const data = {
                title,
                desc: document.getElementById('newTaskDesc').value,
                channel: document.getElementById('newTaskChannel').value,
                priority: document.getElementById('newTaskPriority').value,
                monthIndex: parseInt(document.getElementById('newTaskMonth').value),
                dueDate: document.getElementById('newTaskDueDate').value,
                department: currentDepartment,
                kpi: kpi 
            };

            const ref = collection(db, 'artifacts', appId, 'public', 'data', 'tasks');
            if(id) {
                await updateDoc(doc(ref, id), data);
            } else {
                data.status = 'todo';
                data.createdAt = new Date().toISOString();
                await addDoc(ref, data);
            }
            closeAddTaskModal();
        }

        window.updateStatus = async (id, status) => {
            if(isGuest) return;
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tasks', id), { status });
        }

        window.deleteTask = async (id) => {
            if(isGuest || !confirm('ยืนยันการลบงานนี้หรือไม่?')) return;
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tasks', id));
        }

        window.switchView = (v) => {
            document.getElementById('view-planner').classList.add('hidden');
            document.getElementById('view-dashboard').classList.add('hidden');
            
            // Remove 'active' class and reset style for all nav buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                if (btn.id.startsWith('tab-')) {
                    btn.classList.remove('active');
                    btn.className = btn.className.replace(/bg-sky-\d00|bg-rose-\d00/, 'bg-white'); // Clean up old color classes
                    btn.classList.add('text-slate-600', 'border', 'border-slate-200', 'hover:bg-slate-50');
                }
            });

            // Add 'active' class to the current tab, inheriting its color from --active-bg
            document.getElementById('tab-'+v).classList.add('active');
            document.getElementById('tab-'+v).classList.remove('bg-white', 'text-slate-600', 'border', 'border-slate-200', 'hover:bg-slate-50');

            document.getElementById('view-'+v).classList.remove('hidden');
            
            if (v === 'dashboard') {
                renderDashboard();
            }
        }
    </script>
</body>
</html>
