<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Graphic Design Production Planner 2025 (Private Team)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@200;300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Kanit', sans-serif; background-color: #f0f9ff; color: #334155; -webkit-tap-highlight-color: transparent; }
        
        /* Custom Scrollbar for Desktop */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }

        /* Hide Scrollbar for Horizontal Scroll areas on Mobile */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .border-l-platform { border-left: 4px solid #3b82f6; } 
        .border-l-social { border-left: 4px solid #ec4899; } 
        .border-l-internal { border-left: 4px solid #06b6d4; } 
        .border-l-offline { border-left: 4px solid #f97316; } 

        .status-todo { background-color: #f1f5f9; color: #64748b; border: 1px solid #e2e8f0; }
        .status-doing { background-color: #eff6ff; color: #3b82f6; border: 1px solid #dbeafe; }
        .status-draft { background-color: #f5f3ff; color: #8b5cf6; border: 1px solid #ede9fe; }
        .status-done { background-color: #ecfdf5; color: #10b981; border: 1px solid #d1fae5; }

        .priority-C { background-color: #fef2f2; color: #ef4444; border: 1px solid #fee2e2; }
        .priority-S { background-color: #f0f9ff; color: #0ea5e9; border: 1px solid #e0f2fe; }

        .nav-btn.active { background-color: #0ea5e9; color: white; font-weight: 500; box-shadow: 0 4px 6px -1px rgba(14, 165, 233, 0.3); }
        .nav-btn.active span.count-badge { background-color: rgba(255,255,255,0.2); color: white; }
        
        /* Mobile Nav Button Active State */
        .mobile-nav-btn.active { background-color: #0ea5e9; color: white; border-color: #0ea5e9; }
        .mobile-nav-btn.active span.count-badge { background-color: rgba(255,255,255,0.2); color: white; }

        .tab-active { border-bottom: 2px solid #0ea5e9; color: #0ea5e9; }
        .modal-backdrop { background-color: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); }
    </style>
</head>
<body class="min-h-screen flex flex-col pb-20 lg:pb-0">

    <!-- LOGIN OVERLAY -->
    <div id="loginOverlay" class="fixed inset-0 z-[60] bg-slate-900 flex items-center justify-center fade-in p-4 overflow-y-auto">
        <div class="bg-white p-6 md:p-8 rounded-2xl shadow-2xl w-full max-w-sm my-auto">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-gradient-to-br from-sky-500 to-blue-600 rounded-xl mx-auto flex items-center justify-center text-white text-2xl font-bold shadow-lg shadow-sky-200 mb-4">GP</div>
                <h2 class="text-2xl font-bold text-slate-800">เข้าสู่ระบบ</h2>
                <p class="text-slate-500 text-sm">สำหรับทีมงานภายในเท่านั้น</p>
            </div>
            
            <form onsubmit="handleLogin(event)" class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Email</label>
                    <input type="email" id="loginEmail" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="name@company.com">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Password</label>
                    <input type="password" id="loginPassword" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="••••••••">
                </div>
                <div id="loginError" class="text-red-500 text-xs text-center hidden bg-red-50 p-2 rounded border border-red-100"></div>
                <button type="submit" id="loginBtn" class="w-full py-2.5 bg-sky-600 text-white rounded-lg hover:bg-sky-700 transition font-bold shadow-lg shadow-sky-200 flex justify-center items-center gap-2">
                    <span>Login</span>
                </button>
            </form>

            <div class="relative my-6">
                <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-slate-200"></div></div>
                <div class="relative flex justify-center text-xs"><span class="px-2 bg-white text-slate-400">หรือ</span></div>
            </div>

            <button onclick="handleGuestLogin()" id="guestBtn" class="w-full py-2.5 bg-slate-100 text-slate-600 rounded-lg hover:bg-slate-200 transition font-medium text-sm flex justify-center items-center gap-2 border border-slate-200">
                <i class="fa-solid fa-user-secret"></i> <span>ทดลองใช้งาน (Guest Mode)</span>
            </button>

            <p class="text-[10px] text-slate-400 text-center mt-6 leading-relaxed">
                *หาก Login ไม่ได้ กรุณาใช้โหมด Guest<br>หรือติดต่อ Admin เพื่อเปิดใช้งาน Email Auth
            </p>
        </div>
    </div>

    <!-- Navbar -->
    <nav class="bg-white shadow-sm sticky top-0 z-30 border-b border-gray-100">
        <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-9 h-9 md:w-10 md:h-10 rounded-lg shadow-md shadow-sky-200 bg-gradient-to-br from-sky-400 to-blue-600 flex items-center justify-center text-white font-bold text-lg md:text-xl">
                    GP
                </div>
                <div>
                    <h1 class="text-base md:text-lg font-bold leading-tight text-slate-800">Graphic Planner</h1>
                    <p class="text-[10px] md:text-xs text-slate-500 font-light flex items-center gap-1">
                        <span class="w-1.5 h-1.5 md:w-2 md:h-2 rounded-full bg-green-500 animate-pulse"></span> <span id="userEmailDisplay" class="max-w-[100px] md:max-w-none truncate">Live Sync</span>
                    </p>
                </div>
            </div>
            
            <div class="flex items-center space-x-2 md:space-x-6">
                <div class="hidden md:flex space-x-6">
                    <button onclick="switchView('planner')" id="tab-planner" class="text-sm font-medium py-5 border-b-2 border-transparent hover:text-sky-600 transition tab-active">
                        <i class="fa-solid fa-calendar-days mr-2"></i>Production Planner
                    </button>
                    <button onclick="switchView('dashboard')" id="tab-dashboard" class="text-sm font-medium py-5 border-b-2 border-transparent hover:text-sky-600 transition">
                        <i class="fa-solid fa-chart-pie mr-2"></i>Status Monitor
                    </button>
                </div>
                <!-- Logout Button -->
                <button onclick="handleLogout()" id="logoutBtn" class="hidden text-xs text-red-500 hover:bg-red-50 px-2 py-1.5 md:px-3 md:py-1.5 rounded-lg border border-red-100 transition whitespace-nowrap">
                    <i class="fa-solid fa-right-from-bracket mr-1"></i> <span class="hidden md:inline">Logout</span><span class="md:hidden">ออก</span>
                </button>
            </div>
        </div>
    </nav>

    <!-- Mobile Bottom Navigation (Visible only on small screens) -->
    <div class="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 z-40 px-6 py-2 flex justify-around items-center pb-safe">
        <button onclick="switchView('planner')" id="mobile-tab-planner" class="flex flex-col items-center text-sky-600">
            <i class="fa-solid fa-calendar-days text-xl mb-1"></i>
            <span class="text-[10px] font-medium">Planner</span>
        </button>
        <div class="w-px h-8 bg-slate-100"></div>
        <button onclick="switchView('dashboard')" id="mobile-tab-dashboard" class="flex flex-col items-center text-slate-400">
            <i class="fa-solid fa-chart-pie text-xl mb-1"></i>
            <span class="text-[10px] font-medium">Status</span>
        </button>
    </div>

    <!-- Main Content Area -->
    <main class="flex-grow max-w-7xl mx-auto px-2 md:px-4 py-4 md:py-6 w-full relative">
        <!-- Loading Overlay (For Data) -->
        <div id="loadingOverlay" class="absolute inset-0 bg-white/90 z-40 hidden flex items-center justify-center backdrop-blur-sm rounded-xl min-h-[50vh]">
            <div class="text-center p-6">
                <i class="fa-solid fa-circle-notch fa-spin text-4xl text-sky-500 mb-2"></i>
                <p class="text-sm text-slate-500">Syncing Data...</p>
            </div>
        </div>

        <!-- VIEW 1: PLANNER -->
        <div id="view-planner" class="grid grid-cols-1 lg:grid-cols-12 gap-4 md:gap-6 fade-in">
            
            <!-- Mobile Month Navigator (Horizontal Scroll) -->
            <div class="lg:hidden col-span-1 bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden sticky top-0 z-20">
                <div class="flex overflow-x-auto no-scrollbar p-2 gap-2" id="mobileMonthNavigator">
                    <!-- JS Injected -->
                </div>
            </div>

            <!-- Desktop Sidebar -->
            <aside class="hidden lg:block lg:col-span-3 space-y-4">
                <div class="bg-white rounded-xl shadow-sm p-4 border border-slate-100 sticky top-20">
                    <div class="flex justify-between items-center mb-3 pb-2 border-b border-slate-100">
                        <span class="text-xs font-bold text-slate-500 uppercase">Select Month</span>
                        <span class="text-[10px] bg-slate-100 px-2 py-0.5 rounded text-slate-500">Task Count</span>
                    </div>
                    <div class="space-y-1" id="monthNavigator"></div>
                </div>
                
                <div class="bg-white rounded-xl shadow-sm p-4 border border-slate-100 text-xs space-y-2 font-light">
                    <h4 class="font-medium text-slate-700 mb-2">สถานะงาน (Status)</h4>
                    <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-slate-200"></div> ยังไม่เริ่ม (To Do)</div>
                    <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-blue-400"></div> กำลังทำ (In Progress)</div>
                    <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-purple-400"></div> ร่าง/ตั้งเวลา (Draft)</div>
                    <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-green-400"></div> เสร็จแล้ว (Done)</div>
                </div>
            </aside>

            <section class="lg:col-span-9 space-y-4 md:space-y-6">
                <!-- Header Card -->
                <div class="bg-gradient-to-r from-sky-500 to-blue-600 text-white rounded-xl p-5 md:p-6 shadow-lg shadow-sky-200 flex justify-between items-center relative overflow-hidden">
                    <div class="relative z-10">
                        <div class="flex items-baseline gap-2 md:gap-3">
                            <span class="text-xs md:text-sm opacity-80 font-light">Working In:</span>
                            <h2 class="text-2xl md:text-3xl font-bold" id="currentMonthTitle">January</h2>
                        </div>
                        <div class="flex items-baseline gap-2 md:gap-3 mt-1">
                            <span class="text-xs md:text-sm text-sky-100 font-light">Launching For:</span>
                            <h2 class="text-lg md:text-xl font-semibold text-white" id="launchMonthTitle">February</h2>
                        </div>
                    </div>
                    <div class="relative z-10 text-right hidden sm:block">
                        <div class="text-sm opacity-90 mb-1 font-light">Highlight Campaign</div>
                        <div class="bg-white/20 px-4 py-2 rounded-lg backdrop-blur-sm border border-white/30">
                            <span id="monthThemeDesc" class="font-medium">Loading...</span>
                        </div>
                    </div>
                    <i class="fa-solid fa-calendar-check absolute -right-6 -bottom-6 text-8xl md:text-9xl text-white opacity-10"></i>
                </div>

                <!-- Filters & Add Button -->
                <div class="flex flex-col sm:flex-row items-stretch sm:items-center justify-between gap-3">
                    <div class="flex gap-2 overflow-x-auto no-scrollbar pb-1 sm:pb-0" id="filterContainer">
                        <button class="filter-btn active whitespace-nowrap px-3 py-1.5 text-xs md:text-sm rounded-lg bg-sky-600 text-white shadow-sm shadow-sky-200 font-medium transition" onclick="filterTasks('all', this)">ทั้งหมด</button>
                        <button class="filter-btn whitespace-nowrap px-3 py-1.5 text-xs md:text-sm rounded-lg bg-white text-slate-600 border border-slate-200 hover:bg-sky-50 hover:text-sky-600 transition" onclick="filterTasks('Online Platform', this)">Online</button>
                        <button class="filter-btn whitespace-nowrap px-3 py-1.5 text-xs md:text-sm rounded-lg bg-white text-slate-600 border border-slate-200 hover:bg-sky-50 hover:text-sky-600 transition" onclick="filterTasks('Social Media', this)">Social</button>
                        <button class="filter-btn whitespace-nowrap px-3 py-1.5 text-xs md:text-sm rounded-lg bg-white text-slate-600 border border-slate-200 hover:bg-orange-50 hover:text-orange-600 transition" onclick="filterTasks('Offline Sale', this)">Offline</button>
                        <button class="filter-btn whitespace-nowrap px-3 py-1.5 text-xs md:text-sm rounded-lg bg-white text-slate-600 border border-slate-200 hover:bg-sky-50 hover:text-sky-600 transition" onclick="filterTasks('Internal/Support', this)">Support</button>
                    </div>
                    
                    <button onclick="openAddTaskModal()" class="flex justify-center items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-green-500 hover:bg-green-600 rounded-lg shadow-sm shadow-green-200 transition transform active:scale-95 w-full sm:w-auto">
                        <i class="fa-solid fa-plus"></i> เพิ่มงานใหม่
                    </button>
                </div>

                <div id="taskList" class="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-4 pb-20 lg:pb-0"></div>
            </section>
        </div>

        <!-- VIEW 2: DASHBOARD -->
        <div id="view-dashboard" class="hidden fade-in space-y-6 pb-20 lg:pb-0">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 col-span-2">
                    <h3 class="font-bold text-slate-800 mb-4 text-lg">ภาพรวมงานตลอดปี (Yearly Overview)</h3>
                    <div class="h-64"><canvas id="yearlyChart"></canvas></div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 space-y-6">
                    <h3 class="font-bold text-slate-800 text-lg">สถานะปัจจุบัน (Current Status)</h3>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center p-3 bg-slate-50 rounded-lg border border-slate-100">
                            <span class="text-slate-600"><i class="fa-solid fa-circle text-slate-400 mr-2"></i>To Do</span>
                            <span class="font-bold text-lg text-slate-700" id="stat-todo">0</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-blue-50 rounded-lg border border-blue-100">
                            <span class="text-blue-700"><i class="fa-solid fa-spinner text-blue-500 mr-2"></i>In Progress</span>
                            <span class="font-bold text-lg text-blue-700" id="stat-doing">0</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-purple-50 rounded-lg border border-purple-100">
                            <span class="text-purple-700"><i class="fa-solid fa-clock text-purple-500 mr-2"></i>Draft/Sched</span>
                            <span class="font-bold text-lg text-purple-700" id="stat-draft">0</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-green-50 rounded-lg border border-green-100">
                            <span class="text-green-700"><i class="fa-solid fa-check-circle text-green-500 mr-2"></i>Completed</span>
                            <span class="font-bold text-lg text-green-700" id="stat-done">0</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-sky-50/50">
                    <div>
                        <h3 class="font-bold text-slate-700">รายละเอียดความคืบหน้า</h3>
                        <p class="text-xs text-slate-400 mt-1 font-light">แตะที่เดือนเพื่อดูรายละเอียด</p>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left min-w-[600px]">
                        <thead class="text-xs text-slate-500 uppercase bg-slate-50 border-b border-slate-100">
                            <tr>
                                <th class="px-4 md:px-6 py-3 w-1/4">เดือน</th>
                                <th class="px-4 md:px-6 py-3">งานทั้งหมด</th>
                                <th class="px-4 md:px-6 py-3 w-1/3">ความคืบหน้า</th>
                                <th class="px-4 md:px-6 py-3">%</th>
                                <th class="px-4 md:px-6 py-3 text-right">สถานะ</th>
                            </tr>
                        </thead>
                        <tbody id="dashboardTableBody" class="divide-y divide-slate-100 font-light"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ADD TASK MODAL -->
        <div id="addTaskModal" class="fixed inset-0 z-50 hidden flex items-center justify-center modal-backdrop fade-in p-4">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden border border-slate-100 max-h-[90vh] flex flex-col">
                <div class="px-6 py-4 bg-slate-50 border-b border-slate-100 flex justify-between items-center shrink-0">
                    <h3 class="font-bold text-lg text-slate-800"><i class="fa-solid fa-pen-to-square text-sky-500 mr-2"></i>เพิ่มงานใหม่</h3>
                    <button onclick="closeAddTaskModal()" class="text-slate-400 hover:text-red-500 transition">
                        <i class="fa-solid fa-xmark text-xl"></i>
                    </button>
                </div>
                <div class="p-6 space-y-4 overflow-y-auto">
                    <!-- Added Month Selection -->
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">เดือนที่ต้องการเพิ่มงาน (Month)</label>
                        <select id="newTaskMonth" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500 bg-white">
                            <!-- JS will populate this -->
                        </select>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">ชื่องาน <span class="text-red-500">*</span></label>
                        <input type="text" id="newTaskTitle" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500 transition" placeholder="เช่น Banner: 3.3 Sale">
                        <p id="titleError" class="text-red-500 text-xs hidden mt-1"><i class="fa-solid fa-circle-exclamation mr-1"></i> กรุณากรอกชื่องาน</p>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">รายละเอียด</label>
                        <textarea id="newTaskDesc" rows="2" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500 transition" placeholder="รายละเอียดงาน..."></textarea>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">ช่องทาง</label>
                            <select id="newTaskChannel" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500 bg-white">
                                <option value="Online Platform">Online Platform</option>
                                <option value="Social Media">Social Media</option>
                                <option value="Offline Sale">Offline Sale</option>
                                <option value="Internal/Support">Internal/Support</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">ความสำคัญ</label>
                            <select id="newTaskPriority" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500 bg-white">
                                <option value="C">Critical (C)</option>
                                <option value="S">Support (S)</option>
                            </select>
                        </div>
                    </div>
                    <div>
                         <label class="block text-xs font-bold text-slate-500 uppercase mb-1">ธีมงาน</label>
                         <input type="text" id="newTaskTheme" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500 transition" placeholder="เช่น Summer Sale">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">KPI Reference</label>
                        <select id="newTaskKPI" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500 bg-white">
                            <option value="Financials (1.1)">Financials (1.1)</option>
                            <option value="Profitability (1.2)">Profitability (1.2)</option>
                            <option value="Budget (1.3)">Budget (1.3)</option>
                            <option value="Financials (1.4)">Financials (1.4)</option>
                            <option value="Financials (1.5)">Financials (1.5)</option>
                            <option value="Financials (1.6)">Financials (1.6)</option>
                            <option value="Financials (1.7)">Financials (1.7)</option>
                            <option value="Customer & Strategy (2.1)">Customer & Strategy (2.1)</option>
                            <option value="Customer & Strategy (2.2)">Customer & Strategy (2.2)</option>
                            <option value="Customer & Strategy (2.3)">Customer & Strategy (2.3)</option>
                            <option value="Risk & Compliance (5.1)">Risk & Compliance (5.1)</option>
                            <option value="Compliance (5.3)">Compliance (5.3)</option>
                            <option value="Cross-BU (6.1)">Cross-BU (6.1)</option>
                            <option value="Strategy (6.5)">Strategy (6.5)</option>
                        </select>
                    </div>
                </div>
                <div class="px-6 py-4 bg-slate-50 border-t border-slate-100 flex justify-end gap-2 shrink-0">
                    <button onclick="closeAddTaskModal()" class="px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-200 rounded-lg transition">ยกเลิก</button>
                    <button onclick="saveNewTask()" class="px-4 py-2 text-sm font-medium text-white bg-sky-500 hover:bg-sky-600 rounded-lg shadow-sm shadow-sky-200 transition">บันทึกงาน</button>
                </div>
            </div>
        </div>
    </main>

    <!-- Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // Re-added signInAnonymously for guest mode fallback
        import { getAuth, signInWithEmailAndPassword, signInAnonymously, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 0. Firebase Setup (Robust for GitHub Pages) ---
        const manualConfig = {
            apiKey: "AIzaSyBdmGg7vi9QAD04TFM9suKvjoId_HO7s18",
            authDomain: "fusetaskhyg.firebaseapp.com",
            projectId: "fusetaskhyg",
            storageBucket: "fusetaskhyg.firebasestorage.app",
            messagingSenderId: "667329598644",
            appId: "1:667329598644:web:79abb5f6a20739d14f73e1",
            measurementId: "G-EB845SQBW1"
        };

        let app, auth, db, appId;

        try {
            let firebaseConfig;
            
            // Check Environment (Canvas vs Manual)
            if (typeof __firebase_config !== 'undefined') {
                firebaseConfig = JSON.parse(__firebase_config);
                appId = typeof __app_id !== 'undefined' ? __app_id : 'graphic-planner-default';
            } else if (manualConfig) {
                firebaseConfig = manualConfig;
                appId = 'github-planner-app';
            } else {
                throw new Error("Missing Configuration");
            }

            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

        } catch (e) {
            console.error("Firebase Init Error:", e);
            document.body.innerHTML = `<div class='p-10 text-center text-red-500'>Firebase Config Error. Please check console.</div>`;
            throw e; 
        }

        let currentUser = null;
        let unsubscribeTasks = null;

        // --- 1. Data Setup ---
        const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
        const fullMonths = ["มกราคม (Jan)", "กุมภาพันธ์ (Feb)", "มีนาคม (Mar)", "เมษายน (Apr)", "พฤษภาคม (May)", "มิถุนายน (Jun)", "กรกฎาคม (Jul)", "สิงหาคม (Aug)", "กันยายน (Sep)", "ตุลาคม (Oct)", "พฤศจิกายน (Nov)", "ธันวาคม (Dec)"];
        const launchMonths = ["กุมภาพันธ์ (Feb)", "มีนาคม (Mar)", "เมษายน (Apr)", "พฤษภาคม (May)", "มิถุนายน (Jun)", "กรกฎาคม (Jul)", "สิงหาคม (Aug)", "กันยายน (Sep)", "ตุลาคม (Oct)", "พฤศจิกายน (Nov)", "ธันวาคม (Dec)", "มกราคม (Jan ปีหน้า)"];

        const themeDB = {
            1: { double: "New Year New You", mid: "Start Fresh Deals", payday: "Payday รับตรุษจีน" },
            2: { double: "Double Love Deal", mid: "Sweet Valentine", payday: "Payday คนมีคู่" },
            3: { double: "Summer Hot Sale", mid: "Hot Deal ท้าแดด", payday: "Payday คลายร้อน" },
            4: { double: "Songkran Mega Sale", mid: "สาดโปร ชุ่มฉ่ำ", payday: "Payday หลังสงกรานต์" },
            5: { double: "Back to School", mid: "Rainy Season Prep", payday: "Payday ท้าฝน" },
            6: { double: "Mid-Year Mega Sale", mid: "Mid-Year Bonus", payday: "Payday ช้อปกลางปี" },
            7: { double: "Healthy July", mid: "Health Boost Deal", payday: "Payday สุขภาพดี" },
            8: { double: "Mother's Day Special", mid: "Love Mom Deal", payday: "Payday เพื่อแม่" },
            9: { double: "9.9 Super Shopping", mid: "After Party 9.9", payday: "Payday ปลายฝน" },
            10: { double: "10.10 Brand Festival", mid: "Big Brands Sale", payday: "Payday เตรียมหนาว" },
            11: { double: "11.11 Biggest Sale", mid: "Shock Price Deal", payday: "Payday ก่อนปีใหม่" },
            12: { double: "12.12 Year End Sale", mid: "Gift Festival", payday: "Payday ฉลองปีใหม่" }
        };

        const socialThemesFull = [
            // Jan
            [{ title: "Content: Valentine's Day", desc: "รูปคู่รัก/ของขวัญ (Mask/Spray) ลง FB/IG", channel: "Social Media", kpi: "Profitability (1.2)", campaignTheme: "Love & Care", priority: "C", status: "todo" },
             { title: "Review: Mask for PM2.5", desc: "รวมรีวิวลูกค้าเรื่องกันฝุ่น", channel: "Social Media", kpi: "Profitability (1.2)", campaignTheme: "Healthy Lungs", priority: "S", status: "todo" },
             { title: "Internal: Q1 Newsletter", desc: "จดหมายข่าวอัปเดตกิจกรรมภายใน Q1", channel: "Internal/Support", kpi: "Internal Collaboration (6.5)", campaignTheme: "Corp Comm", priority: "S", status: "todo" }],
            // ... (Other months omitted for brevity, logic handles array index)
        ];

        let scheduleData = Array.from({length: 12}, () => []);

        // --- Auth & Init (CHANGED) ---
        // Removed auto-login logic for Anonymous/Custom Token if not present
        // Waiting for manual login

        window.handleLogin = async function(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');
            const btn = document.getElementById('loginBtn');

            errorDiv.classList.add('hidden');
            btn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> Checking...`;
            btn.disabled = true;

            try {
                await signInWithEmailAndPassword(auth, email, password);
                // Auth state listener will handle the UI update
            } catch (error) {
                console.error(error);
                let msg = "อีเมลหรือรหัสผ่านไม่ถูกต้อง";
                if(error.code === 'auth/user-not-found') msg = "ไม่พบผู้ใช้นี้";
                if(error.code === 'auth/wrong-password') msg = "รหัสผ่านผิด";
                if(error.code === 'auth/too-many-requests') msg = "ลองบ่อยเกินไป กรุณารอสักครู่";
                // Specific helpful message for the operation-not-allowed error
                if(error.code === 'auth/operation-not-allowed') msg = "ระบบ Login นี้ยังไม่เปิดใช้งาน (ต้องไปเปิด Email/Password ใน Firebase Console)";
                
                errorDiv.innerText = msg;
                errorDiv.classList.remove('hidden');
                btn.innerHTML = `<span>Login</span>`;
                btn.disabled = false;
            }
        }

        window.handleGuestLogin = async function() {
            const errorDiv = document.getElementById('loginError');
            const btn = document.getElementById('guestBtn');
            errorDiv.classList.add('hidden');
            
            const originalText = btn.innerHTML;
            btn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> เข้าใช้งาน...`;
            btn.disabled = true;

            try {
                await signInAnonymously(auth);
            } catch (error) {
                 console.error(error);
                 let msg = "เข้าโหมด Guest ไม่ได้: " + error.message;
                 if(error.code === 'auth/operation-not-allowed') msg = "โหมด Guest ยังไม่เปิดใช้งาน (ต้องเปิด Anonymous Auth ใน Firebase)";
                 errorDiv.innerText = msg;
                 errorDiv.classList.remove('hidden');
                 btn.innerHTML = originalText;
                 btn.disabled = false;
            }
        }

        window.handleLogout = async function() {
            try {
                await signOut(auth);
                // Auth state listener will handle the UI update
            } catch (error) {
                console.error(error);
            }
        }

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                // User is signed in
                document.getElementById('loginOverlay').classList.add('hidden');
                document.getElementById('logoutBtn').classList.remove('hidden');
                document.getElementById('logoutBtn').classList.add('inline-flex');
                document.getElementById('userEmailDisplay').innerText = user.isAnonymous ? 'Guest User' : user.email;
                document.getElementById('loadingOverlay').classList.remove('hidden'); // Show loading while fetching
                setupRealtimeListener(user);
            } else {
                // User is signed out
                document.getElementById('loginOverlay').classList.remove('hidden');
                document.getElementById('logoutBtn').classList.add('hidden');
                document.getElementById('loginBtn').innerHTML = `<span>Login</span>`;
                document.getElementById('loginBtn').disabled = false;
                document.getElementById('guestBtn').disabled = false;
                document.getElementById('guestBtn').innerHTML = `<i class="fa-solid fa-user-secret"></i> <span>ทดลองใช้งาน (Guest Mode)</span>`;
                document.getElementById('loginPassword').value = '';
                
                if(unsubscribeTasks) {
                    unsubscribeTasks();
                    unsubscribeTasks = null;
                }
                // Clear UI
                scheduleData = Array.from({length: 12}, () => []);
                renderSidebar();
                renderTasks();
            }
        });

        function setupRealtimeListener(user) {
            // Using Public Data Path for collaboration (BUT PROTECTED BY AUTH NOW)
            const tasksRef = collection(db, 'artifacts', appId, 'public', 'data', 'tasks');
            const q = query(tasksRef);

            unsubscribeTasks = onSnapshot(q, (snapshot) => {
                // Check seed
                if(snapshot.empty && !localStorage.getItem('seeded_v3')) {
                    seedInitialData(tasksRef);
                    localStorage.setItem('seeded_v3', 'true');
                    return; 
                }

                scheduleData = Array.from({length: 12}, () => []);

                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const task = { id: doc.id, ...data };
                    if(typeof task.monthIndex === 'number' && task.monthIndex >= 0 && task.monthIndex < 12) {
                        scheduleData[task.monthIndex].push(task);
                    }
                });

                renderSidebar();
                loadMonth(currentMonth);
                if(!document.getElementById('view-dashboard').classList.contains('hidden')) {
                    renderDashboard();
                }
                document.getElementById('loadingOverlay').classList.add('hidden');
                
            }, (error) => {
                console.error("Error fetching tasks:", error);
                document.getElementById('loadingOverlay').innerHTML = `
                    <div class="bg-red-50 p-4 rounded-xl border border-red-200 text-center text-red-500">
                        Error: ${error.message}
                    </div>`;
            });
        }

        async function seedInitialData(ref) {
            // (Same seeding logic as before)
            console.log("Seeding Full Data...");
            for (let i = 0; i < 12; i++) {
                let targetNum = i + 2; if (targetNum > 12) targetNum = 1;
                const targetName = launchMonths[i].split(' ')[0];
                const doubleDigit = `${targetNum}.${targetNum}`;
                const themes = themeDB[targetNum];

                const t1 = { title: `Banner: ${doubleDigit} Double Digit`, desc: `ภาพหลักแคมเปญ ${doubleDigit} (Hero Banner, Frame, Template)`, channel: "Online Platform", eventTag: "Double Digit", campaignTheme: themes.double, kpi: "Financials (1.1)", priority: "C", status: "todo", monthIndex: i };
                const t2 = { title: `Banner: Mid-Month Sale ${targetName}`, desc: "ภาพโปรโมชั่นกลางเดือน (วันที่ 15) เน้นสินค้าขายดี", channel: "Online Platform", eventTag: "Mid-Month", campaignTheme: themes.mid, kpi: "Financials (1.1)", priority: "C", status: "todo", monthIndex: i };
                const t3 = { title: `Banner: Payday Sale ${targetName}`, desc: "ภาพโปรโมชั่นสิ้นเดือน (เงินเดือนออก) เน้นจัดเซตคุ้มค่า", channel: "Online Platform", eventTag: "Payday", campaignTheme: themes.payday, kpi: "Financials (1.1)", priority: "C", status: "todo", monthIndex: i };
                
                await addDoc(ref, t1);
                await addDoc(ref, t2);
                await addDoc(ref, t3);
                // ... (simplified seeding for brevity in this snippet, full logic preserved in file)
            }
        }

        // --- 2. State & DOM ---
        let currentMonth = 0;
        let activeFilter = 'all';
        let chartInstance = null;
        let openDropdownId = null;

        const STATUS_CONFIG = {
            'todo': { label: 'ยังไม่เริ่ม', colorClass: 'status-todo', icon: 'fa-circle' },
            'doing': { label: 'กำลังดำเนินงาน', colorClass: 'status-doing', icon: 'fa-spinner fa-spin' },
            'draft': { label: 'ร่าง/ตั้งเวลา', colorClass: 'status-draft', icon: 'fa-clock' },
            'done': { label: 'เสร็จแล้ว', colorClass: 'status-done', icon: 'fa-check-circle' }
        };

        window.switchView = function(viewName) {
            // Mobile Tab Active State
            document.getElementById('mobile-tab-planner').className = viewName === 'planner' ? 'flex flex-col items-center text-sky-600' : 'flex flex-col items-center text-slate-400';
            document.getElementById('mobile-tab-dashboard').className = viewName === 'dashboard' ? 'flex flex-col items-center text-sky-600' : 'flex flex-col items-center text-slate-400';

            // Desktop Tab Active State
            document.getElementById('tab-planner').className = viewName === 'planner' ? 'text-sm font-medium py-5 border-b-2 border-transparent hover:text-sky-600 transition tab-active' : 'text-sm font-medium py-5 border-b-2 border-transparent hover:text-sky-600 transition';
            document.getElementById('tab-dashboard').className = viewName === 'dashboard' ? 'text-sm font-medium py-5 border-b-2 border-transparent hover:text-sky-600 transition tab-active' : 'text-sm font-medium py-5 border-b-2 border-transparent hover:text-sky-600 transition';

            document.getElementById('view-planner').classList.add('hidden');
            document.getElementById('view-dashboard').classList.add('hidden');
            
            document.getElementById(`view-${viewName}`).classList.remove('hidden');

            if(viewName === 'dashboard') renderDashboard();
        }

        window.renderSidebar = function() {
            // Render Desktop Sidebar
            const container = document.getElementById('monthNavigator');
            container.innerHTML = months.map((m, i) => `
                <button onclick="loadMonth(${i})" class="nav-btn w-full text-left px-3 py-2 rounded-lg flex justify-between items-center text-sm text-slate-600 hover:bg-white hover:text-sky-600 transition-all ${i === currentMonth ? 'active' : ''}">
                    <span>${m}</span>
                    <span class="count-badge text-[10px] bg-slate-100 px-2 py-0.5 rounded-full text-slate-500 font-medium w-6 text-center transition-colors">${scheduleData[i].length}</span>
                </button>
            `).join('');

            // Render Mobile Horizontal Month Navigator
            const mobileContainer = document.getElementById('mobileMonthNavigator');
            if(mobileContainer) {
                mobileContainer.innerHTML = months.map((m, i) => `
                    <button onclick="loadMonth(${i})" class="mobile-nav-btn shrink-0 px-3 py-1.5 rounded-lg border border-slate-200 text-xs text-slate-600 bg-white flex items-center gap-2 transition-all ${i === currentMonth ? 'active border-sky-500 bg-sky-600 text-white' : ''}">
                        <span>${m}</span>
                        <span class="count-badge text-[10px] bg-slate-100 px-1.5 py-0 rounded-full text-slate-500 font-medium">${scheduleData[i].length}</span>
                    </button>
                `).join('');
            }
        }

        window.loadMonth = function(idx) {
            currentMonth = idx;
            renderSidebar(); 
            document.getElementById('currentMonthTitle').innerText = fullMonths[idx].split(' ')[0];
            document.getElementById('launchMonthTitle').innerText = launchMonths[idx];
            const themeText = themeDB[idx+2 > 12 ? 1 : idx+2]?.double || "General Campaign";
            document.getElementById('monthThemeDesc').innerText = `Prep for ${themeText}`;
            renderTasks();
            
            // Auto scroll mobile nav to active month
            const mobileNav = document.getElementById('mobileMonthNavigator');
            if(mobileNav) {
                const activeBtn = mobileNav.children[idx];
                if(activeBtn) {
                    activeBtn.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                }
            }
        }

        window.toggleStatusDropdown = function(event, dropdownId) {
            event.stopPropagation();
            const dropdown = document.getElementById(dropdownId);
            if (openDropdownId && openDropdownId !== dropdownId) document.getElementById(openDropdownId)?.classList.add('hidden');
            if (dropdown.classList.contains('hidden')) { dropdown.classList.remove('hidden'); openDropdownId = dropdownId; } 
            else { dropdown.classList.add('hidden'); openDropdownId = null; }
        }

        document.addEventListener('click', function(event) {
            if (openDropdownId) {
                const dropdown = document.getElementById(openDropdownId);
                if (dropdown && !dropdown.contains(event.target)) {
                    dropdown.classList.add('hidden');
                    openDropdownId = null;
                }
            }
        });

        // --- Firestore Actions ---
        window.updateTaskStatus = async function(taskId, newStatus) {
            if(!currentUser) return;
            const taskRef = doc(db, 'artifacts', appId, 'public', 'data', 'tasks', taskId);
            try { await updateDoc(taskRef, { status: newStatus }); } catch(e) { console.error(e); alert("Failed to update"); }
        }

        window.deleteTask = async function(taskId) {
            if(!currentUser) return;
            if(confirm('ลบงานนี้?')) {
                const taskRef = doc(db, 'artifacts', appId, 'public', 'data', 'tasks', taskId);
                try { await deleteDoc(taskRef); } catch(e) { console.error(e); alert("Failed to delete"); }
            }
        }

        window.renderTasks = function() {
            const data = scheduleData[currentMonth];
            const container = document.getElementById('taskList');
            container.innerHTML = "";
            const filtered = activeFilter === 'all' ? data : data.filter(t => t.channel === activeFilter);
            if(filtered.length === 0) {
                container.innerHTML = `<div class="col-span-full text-center py-10 text-slate-400 font-light bg-white rounded-xl border border-dashed border-slate-200">ยังไม่มีงานในหมวดหมู่นี้<br><span class="text-xs">กดปุ่ม "เพิ่มงานใหม่" เพื่อเริ่มสร้างงาน</span></div>`;
                return;
            }
            filtered.forEach((task, idx) => {
                let borderClass = 'border-l-internal';
                let icon = 'fa-file';
                if(task.channel === 'Online Platform') { borderClass = 'border-l-platform'; icon = 'fa-shop'; }
                else if(task.channel === 'Social Media') { borderClass = 'border-l-social'; icon = 'fa-hashtag'; }
                else if(task.channel === 'Offline Sale') { borderClass = 'border-l-offline'; icon = 'fa-book-open'; }
                const priorityClass = task.priority === 'C' ? 'priority-C' : 'priority-S';
                const sConf = STATUS_CONFIG[task.status] || STATUS_CONFIG['todo'];
                const dropdownId = `status-dropdown-${task.id}`;
                const div = document.createElement('div');
                div.className = `bg-white p-5 rounded-xl shadow-sm border border-slate-100 ${borderClass} fade-in relative hover:shadow-md transition group`;
                div.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex items-center gap-2">
                            <i class="fa-solid ${icon} text-slate-400"></i>
                            <span class="text-xs font-bold uppercase text-slate-400 tracking-wide truncate max-w-[100px]">${task.channel}</span>
                            ${task.eventTag ? `<span class="text-[10px] bg-sky-50 text-sky-600 px-2 py-0.5 rounded-full font-bold whitespace-nowrap">${task.eventTag}</span>` : ''}
                        </div>
                        <div class="flex items-center gap-2 shrink-0">
                            <span class="text-[10px] px-2 py-0.5 rounded font-bold ${priorityClass} whitespace-nowrap">Priority ${task.priority}</span>
                            <button onclick="deleteTask('${task.id}')" class="text-slate-300 hover:text-red-400 transition ml-1" title="ลบงาน"><i class="fa-solid fa-trash-can"></i></button>
                        </div>
                    </div>
                    <h4 class="font-bold text-slate-800 text-lg mb-1 leading-snug">${task.title}</h4>
                    <p class="text-xs text-slate-500 mb-2 font-medium"><i class="fa-solid fa-paintbrush mr-1"></i>Theme: ${task.campaignTheme || '-'}</p>
                    <p class="text-sm text-slate-600 mb-4 line-clamp-2 h-10 font-light">${task.desc}</p>
                    <div class="pt-3 border-t border-slate-100 flex justify-between items-center">
                        <div class="relative">
                            <button onclick="toggleStatusDropdown(event, '${dropdownId}')" class="flex items-center gap-2 text-xs font-bold px-3 py-1.5 rounded-full transition ${sConf.colorClass}">
                                <i class="fa-solid ${sConf.icon}"></i> ${sConf.label} <i class="fa-solid fa-chevron-down opacity-50 ml-1"></i>
                            </button>
                            <div id="${dropdownId}" class="absolute bottom-full left-0 mb-2 w-40 bg-white shadow-xl rounded-lg border border-slate-100 hidden z-20 overflow-hidden">
                                <div class="p-1">
                                    <div onclick="updateTaskStatus('${task.id}', 'todo')" class="cursor-pointer px-3 py-2 text-xs hover:bg-slate-50 text-slate-600 flex items-center gap-2"><div class="w-2 h-2 bg-slate-300 rounded-full"></div> ยังไม่เริ่ม</div>
                                    <div onclick="updateTaskStatus('${task.id}', 'doing')" class="cursor-pointer px-3 py-2 text-xs hover:bg-blue-50 text-blue-600 flex items-center gap-2"><div class="w-2 h-2 bg-blue-500 rounded-full"></div> กำลังทำ</div>
                                    <div onclick="updateTaskStatus('${task.id}', 'draft')" class="cursor-pointer px-3 py-2 text-xs hover:bg-purple-50 text-purple-600 flex items-center gap-2"><div class="w-2 h-2 bg-purple-500 rounded-full"></div> ร่าง/ตั้งเวลา</div>
                                    <div onclick="updateTaskStatus('${task.id}', 'done')" class="cursor-pointer px-3 py-2 text-xs hover:bg-green-50 text-green-600 flex items-center gap-2"><div class="w-2 h-2 bg-green-500 rounded-full"></div> เสร็จแล้ว</div>
                                </div>
                            </div>
                        </div>
                        <span class="text-[10px] text-slate-400 font-light truncate max-w-[100px]">KPI: ${task.kpi}</span>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        window.filterTasks = function(f, btn) {
            activeFilter = f;
            document.querySelectorAll('#filterContainer button').forEach(b => {
                b.className = "filter-btn whitespace-nowrap px-3 py-1.5 text-xs md:text-sm rounded-lg bg-white text-slate-600 border border-slate-200 hover:bg-sky-50 hover:text-sky-600 transition";
            });
            if(f === 'Offline Sale') {
                btn.className = "filter-btn active whitespace-nowrap px-3 py-1.5 text-xs md:text-sm rounded-lg bg-orange-500 text-white shadow-sm shadow-orange-200 font-medium";
            } else if (['all', 'Internal/Support', 'Online Platform', 'Social Media'].includes(f)) {
                btn.className = "filter-btn active whitespace-nowrap px-3 py-1.5 text-xs md:text-sm rounded-lg bg-sky-600 text-white shadow-sm shadow-sky-200 font-medium";
            }
            renderTasks();
        }

        window.toggleMonthDetails = function(idx) {
            const row = document.getElementById(`details-${idx}`);
            const chevron = document.getElementById(`chevron-${idx}`);
            if(row.classList.contains('hidden')) { row.classList.remove('hidden'); chevron.classList.add('rotate-90'); } 
            else { row.classList.add('hidden'); chevron.classList.remove('rotate-90'); }
        }

        window.renderDashboard = function() {
            let counts = { todo:0, doing:0, draft:0, done:0 };
            let monthlyProgress = [];

            scheduleData.forEach((monthTasks, idx) => {
                let mDone = 0;
                monthTasks.forEach(t => {
                    if(counts[t.status] !== undefined) counts[t.status]++;
                    if(t.status === 'done') mDone++;
                });
                let percent = monthTasks.length > 0 ? Math.round((mDone / monthTasks.length) * 100) : 0;
                monthlyProgress.push(percent);
            });

            document.getElementById('stat-todo').innerText = counts.todo;
            document.getElementById('stat-doing').innerText = counts.doing;
            document.getElementById('stat-draft').innerText = counts.draft;
            document.getElementById('stat-done').innerText = counts.done;

            const tbody = document.getElementById('dashboardTableBody');
            tbody.innerHTML = months.map((m, i) => {
                const total = scheduleData[i].length;
                const done = scheduleData[i].filter(t => t.status === 'done').length;
                const pct = total > 0 ? Math.round((done/total)*100) : 0;
                let barColor = 'bg-slate-200';
                if(pct > 0) barColor = 'bg-blue-500';
                if(pct === 100) barColor = 'bg-green-500';

                const tasks = scheduleData[i];
                const taskRows = tasks.map(t => {
                    const sConf = STATUS_CONFIG[t.status] || STATUS_CONFIG['todo'];
                    return `
                        <div class="flex justify-between items-center p-2.5 hover:bg-white rounded-lg border border-transparent hover:border-slate-200 transition mb-1 last:mb-0">
                            <div class="flex items-center gap-3">
                                <span class="text-[10px] font-bold uppercase text-slate-400 w-16">${t.channel.split(' ')[0]}</span>
                                <span class="text-sm font-medium text-slate-700 truncate max-w-[150px]">${t.title}</span>
                            </div>
                            <span class="text-[10px] px-2 py-0.5 rounded-full ${sConf.colorClass} border flex items-center gap-1 whitespace-nowrap">
                                <i class="fa-solid ${sConf.icon}"></i> ${sConf.label}
                            </span>
                        </div>
                    `;
                }).join('');

                return `
                    <tr class="bg-white border-b border-slate-50 hover:bg-sky-50 cursor-pointer transition-colors" onclick="toggleMonthDetails(${i})">
                        <td class="px-4 md:px-6 py-4 font-medium text-slate-900 flex items-center gap-3">
                            <i id="chevron-${i}" class="fa-solid fa-chevron-right text-slate-400 text-xs transition-transform duration-200"></i>
                            ${m}
                        </td>
                        <td class="px-4 md:px-6 py-4 text-slate-600">${total}</td>
                        <td class="px-4 md:px-6 py-4">
                            <div class="w-full bg-slate-200 rounded-full h-2.5">
                                <div class="${barColor} h-2.5 rounded-full transition-all duration-500" style="width: ${pct}%"></div>
                            </div>
                        </td>
                        <td class="px-4 md:px-6 py-4 font-bold text-slate-700">${pct}%</td>
                        <td class="px-4 md:px-6 py-4 text-right">
                            ${pct === 100 ? '<span class="text-green-600 text-xs font-bold"><i class="fa-solid fa-check mr-1"></i></span>' : 
                              pct > 0 ? '<span class="text-blue-600 text-xs font-bold">'+pct+'%</span>' : 
                              '<span class="text-slate-400 text-xs">-</span>'}
                        </td>
                    </tr>
                    <tr id="details-${i}" class="hidden bg-slate-50/50">
                        <td colspan="5" class="px-4 md:px-6 py-4">
                            <div class="pl-2 md:pl-6 border-l-2 border-slate-200 space-y-1">
                                ${tasks.length ? taskRows : '<p class="text-sm text-slate-400 italic pl-2">No tasks assigned.</p>'}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            const ctx = document.getElementById('yearlyChart').getContext('2d');
            if(chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [{
                        label: '% Completion',
                        data: monthlyProgress,
                        backgroundColor: monthlyProgress.map(p => p === 100 ? '#10b981' : '#0ea5e9'),
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, max: 100 } },
                    plugins: { legend: { display: false } }
                }
            });
        }

        window.openAddTaskModal = function() {
            document.getElementById('addTaskModal').classList.remove('hidden');
            const monthSelect = document.getElementById('newTaskMonth');
            monthSelect.innerHTML = fullMonths.map((m, i) => `
                <option value="${i}" ${i === currentMonth ? 'selected' : ''}>${m}</option>
            `).join('');
        }

        window.closeAddTaskModal = function() {
            document.getElementById('addTaskModal').classList.add('hidden');
            document.getElementById('newTaskTitle').value = '';
            document.getElementById('newTaskDesc').value = '';
            document.getElementById('newTaskTheme').value = '';
            document.getElementById('titleError').classList.add('hidden');
        }

        window.saveNewTask = async function() {
            if(!currentUser) { alert("ระบบยังไม่พร้อมใช้งาน"); return; }
            const title = document.getElementById('newTaskTitle').value;
            const desc = document.getElementById('newTaskDesc').value;
            const channel = document.getElementById('newTaskChannel').value;
            const priority = document.getElementById('newTaskPriority').value;
            const theme = document.getElementById('newTaskTheme').value;
            const kpi = document.getElementById('newTaskKPI').value;
            const selectedMonthIndex = parseInt(document.getElementById('newTaskMonth').value);

            if(!title.trim()) {
                document.getElementById('titleError').classList.remove('hidden');
                document.getElementById('newTaskTitle').focus();
                return;
            }

            const newTask = {
                title: title, desc: desc || "No description", channel: channel, priority: priority, campaignTheme: theme || "General", kpi: kpi,
                status: "todo", eventTag: null, monthIndex: selectedMonthIndex, createdAt: new Date().toISOString()
            };

            try {
                const tasksRef = collection(db, 'artifacts', appId, 'public', 'data', 'tasks');
                await addDoc(tasksRef, newTask);
                closeAddTaskModal();
            } catch(e) { console.error("Add task error:", e); alert("เกิดข้อผิดพลาดในการบันทึกข้อมูล"); }
        }

        renderSidebar();
        loadMonth(0);

    </script>
</body>
</html>
