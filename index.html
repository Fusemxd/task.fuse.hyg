<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Insta-Planner 2025</title>
    
    <!-- FAVICON -->
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/Fusemxd/task.fuse.hyg/37e17d0f0f712995e6e21546cba558911aecb74a/3.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@200;300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Kanit', sans-serif; background-color: #fafafa; color: #262626; -webkit-tap-highlight-color: transparent; padding-bottom: 60px; }
        
        /* Hide Scrollbar but allow scrolling */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Story Gradient Ring */
        .story-ring-active { background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%); padding: 2px; }
        .story-ring-inactive { background: #dbdbdb; padding: 2px; }
        
        /* App Container for Desktop View (simulate mobile) */
        @media (min-width: 768px) {
            #app-container { max-width: 480px; margin: 0 auto; border-left: 1px solid #dbdbdb; border-right: 1px solid #dbdbdb; min-height: 100vh; background: white; }
            body { background-color: #fafafa; }
        }
        @media (max-width: 767px) {
            #app-container { background: white; min-height: 100vh; }
        }

        /* Carousel Snap */
        .snap-x-mandatory { scroll-snap-type: x mandatory; }
        .snap-center { scroll-snap-align: center; }

        .like-anim { animation: likeBounce 0.4s; }
        @keyframes likeBounce { 0% { transform: scale(1); } 50% { transform: scale(1.3); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

<div id="app-container" class="relative">

    <!-- TOP BAR -->
    <header class="sticky top-0 z-40 bg-white border-b border-gray-200 h-14 flex items-center justify-between px-4">
        <div class="font-['Inter'] font-bold text-xl tracking-tight flex items-center gap-2">
            Production<span class="text-xs font-normal border border-black px-1 rounded">Planner</span>
        </div>
        <div class="flex items-center gap-4">
            <!-- Team Switcher as Icon -->
            <button onclick="toggleDept()" id="deptIconBtn" class="text-2xl transition transform active:scale-90">
                <i class="fa-solid fa-palette text-black" id="topBarIcon"></i>
            </button>
            <div class="relative">
                <i class="fa-regular fa-heart text-2xl"></i>
                <div class="absolute -top-1 -right-1 w-2 h-2 bg-red-500 rounded-full"></div>
            </div>
        </div>
    </header>

    <!-- MAIN FEED VIEW -->
    <div id="view-feed" class="fade-in">
        
        <!-- STORIES (Months) -->
        <div class="bg-white border-b border-gray-100 py-3">
            <div class="flex overflow-x-auto no-scrollbar px-4 gap-4" id="storiesContainer">
                <!-- Stories injected by JS -->
            </div>
        </div>

        <!-- FILTERS (Chips) -->
        <div class="sticky top-14 z-30 bg-white/95 backdrop-blur-sm py-2 px-4 border-b border-gray-100 flex gap-2 overflow-x-auto no-scrollbar" id="filterContainer">
            <!-- Filters injected by JS -->
        </div>

        <!-- POSTS FEED -->
        <div id="feedList" class="pb-20">
            <!-- Posts injected by JS -->
        </div>
    </div>

    <!-- SEARCH VIEW (Overlay) -->
    <div id="view-search" class="hidden fade-in p-4 pb-20">
        <div class="relative mb-4">
            <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
            <input type="text" id="searchInput" oninput="handleSearch()" placeholder="ค้นหา" class="w-full bg-gray-100 rounded-lg pl-10 pr-4 py-2 focus:outline-none focus:ring-1 focus:ring-gray-300">
        </div>
        <div class="grid grid-cols-3 gap-1" id="searchGrid">
            <!-- Grid Results -->
        </div>
    </div>

    <!-- DASHBOARD VIEW -->
    <div id="view-dashboard" class="hidden fade-in p-4 pb-20">
        <h2 class="text-xl font-bold mb-4">Professional Dashboard</h2>
        <div class="bg-gray-100 p-4 rounded-lg mb-6">
            <h3 class="text-sm text-gray-500 mb-1">Monthly Completion</h3>
            <div class="h-48"><canvas id="monthlyChart"></canvas></div>
        </div>
        <div class="space-y-4" id="dashboardStats">
            <!-- Stats -->
        </div>
    </div>

    <!-- BOTTOM NAVIGATION -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 h-14 flex items-center justify-around z-50 max-w-[480px] mx-auto">
        <button onclick="switchView('feed')" id="nav-feed" class="text-2xl text-black"><i class="fa-solid fa-house"></i></button>
        <button onclick="switchView('search')" id="nav-search" class="text-2xl text-gray-400"><i class="fa-solid fa-magnifying-glass"></i></button>
        <button onclick="openAddTaskModal()" class="text-3xl text-black transform hover:scale-110 transition"><i class="fa-regular fa-square-plus"></i></button>
        <button onclick="switchView('dashboard')" id="nav-dashboard" class="text-2xl text-gray-400"><i class="fa-solid fa-chart-pie"></i></button>
        <button onclick="handleLogout()" class="w-6 h-6 rounded-full bg-gray-200 overflow-hidden border border-gray-300">
            <img src="https://ui-avatars.com/api/?name=User&background=random" class="w-full h-full object-cover">
        </button>
    </nav>

</div>

<!-- LOGIN OVERLAY -->
<div id="loginOverlay" class="fixed inset-0 z-[60] bg-white flex flex-col items-center justify-center fade-in p-8">
    <div class="mb-8 text-center">
        <div class="w-20 h-20 mx-auto mb-4 bg-gradient-to-tr from-yellow-400 via-red-500 to-purple-600 rounded-2xl flex items-center justify-center p-1">
            <div class="bg-white w-full h-full rounded-xl flex items-center justify-center overflow-hidden">
                <img src="https://raw.githubusercontent.com/Fusemxd/task.fuse.hyg/37e17d0f0f712995e6e21546cba558911aecb74a/3.png" class="w-16">
            </div>
        </div>
        <h1 class="font-['Inter'] text-3xl font-bold mb-2">Insta-Planner</h1>
        <p class="text-gray-500">Graphic & Video Production</p>
    </div>
    <form onsubmit="handleLogin(event)" class="w-full max-w-xs space-y-3">
        <input type="email" id="loginEmail" class="w-full border border-gray-300 rounded px-3 py-2.5 text-sm bg-gray-50 focus:bg-white focus:border-gray-400 focus:outline-none" placeholder="Email">
        <input type="password" id="loginPassword" class="w-full border border-gray-300 rounded px-3 py-2.5 text-sm bg-gray-50 focus:bg-white focus:border-gray-400 focus:outline-none" placeholder="Password">
        <button type="submit" id="loginBtn" class="w-full bg-blue-500 text-white font-semibold py-2 rounded hover:bg-blue-600 transition">Log In</button>
    </form>
    <div class="mt-6 flex items-center w-full max-w-xs">
        <div class="flex-grow border-t border-gray-300"></div>
        <span class="px-4 text-gray-400 text-xs font-semibold">OR</span>
        <div class="flex-grow border-t border-gray-300"></div>
    </div>
    <button onclick="handleGuestLogin()" id="guestBtn" class="mt-6 text-blue-900 font-semibold text-sm">Log in as Guest</button>
</div>

<!-- ADD/EDIT TASK MODAL -->
<div id="addTaskModal" class="fixed inset-0 z-[70] hidden bg-black/50 flex items-end md:items-center justify-center fade-in">
    <div class="bg-white w-full md:max-w-md md:rounded-xl rounded-t-2xl max-h-[90vh] flex flex-col overflow-hidden">
        <div class="h-12 border-b border-gray-100 flex items-center justify-between px-4 shrink-0">
            <button onclick="closeAddTaskModal()" class="text-gray-500 font-medium">Cancel</button>
            <h3 class="font-bold text-lg" id="modalTitle">New Post</h3>
            <button onclick="handleSaveTask()" class="text-blue-500 font-bold">Share</button>
        </div>
        <div class="overflow-y-auto p-4 space-y-4">
            <input type="hidden" id="editingTaskId">
            
            <!-- Image Uploader -->
            <div class="flex gap-4 overflow-x-auto pb-2" id="modalImagePreview">
                <label class="shrink-0 w-24 h-24 bg-gray-100 border border-gray-300 rounded flex flex-col items-center justify-center cursor-pointer text-gray-400 hover:bg-gray-200 transition">
                    <i class="fa-solid fa-camera text-2xl mb-1"></i>
                    <span class="text-[10px]">Add Photo</span>
                    <input type="file" id="newTaskImageInput" accept="image/*" class="hidden" multiple onchange="handleImageSelect(this)">
                </label>
            </div>

            <!-- Content -->
            <div class="flex gap-3">
                <div class="w-8 h-8 rounded-full bg-gray-200 shrink-0 overflow-hidden">
                    <img src="https://ui-avatars.com/api/?name=Me" class="w-full h-full">
                </div>
                <div class="flex-grow space-y-2">
                    <input type="text" id="newTaskTitle" class="w-full text-sm font-medium focus:outline-none" placeholder="Write a caption... (Title)">
                    <textarea id="newTaskDesc" rows="3" class="w-full text-sm text-gray-600 focus:outline-none resize-none" placeholder="Description details..."></textarea>
                    <input type="text" id="newTaskRemark" class="w-full text-xs text-yellow-600 bg-yellow-50 p-2 rounded focus:outline-none" placeholder="Add remark/note...">
                </div>
            </div>

            <!-- Meta Fields -->
            <div class="border-t border-gray-100 pt-2 space-y-3">
                <div class="flex items-center justify-between py-2 border-b border-gray-50">
                    <span class="text-sm">Month</span>
                    <select id="newTaskMonth" class="text-sm text-blue-500 font-medium bg-transparent focus:outline-none text-right"></select>
                </div>
                <div class="flex items-center justify-between py-2 border-b border-gray-50">
                    <span class="text-sm">Due Date</span>
                    <input type="date" id="newTaskDueDate" class="text-sm text-gray-500 focus:outline-none text-right">
                </div>
                <div class="flex items-center justify-between py-2 border-b border-gray-50">
                    <span class="text-sm">Category</span>
                    <select id="newTaskChannel" class="text-sm text-gray-500 bg-transparent focus:outline-none text-right w-1/2"></select>
                </div>
                <div class="flex items-center justify-between py-2 border-b border-gray-50">
                    <span class="text-sm">KPI</span>
                    <select id="newTaskKPI" class="text-sm text-gray-500 bg-transparent focus:outline-none text-right w-1/2"></select>
                </div>
                <div class="flex items-center justify-between py-2">
                    <span class="text-sm">Priority</span>
                    <select id="newTaskPriority" class="text-sm text-gray-500 bg-transparent focus:outline-none text-right">
                        <option value="S">Support (General)</option>
                        <option value="C">Critical (High)</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, signInAnonymously, signOut, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Configuration
    const firebaseConfig = {
        apiKey: "AIzaSyBdmGg7vi9QAD04TFM9suKvjoId_HO7s18",
        authDomain: "fusetaskhyg.firebaseapp.com",
        projectId: "fusetaskhyg",
        storageBucket: "fusetaskhyg.firebasestorage.app",
        messagingSenderId: "667329598644",
        appId: "1:667329598644:web:79abb5f6a20739d14f73e1"
    };
    const appId = 'graphic-planner-default';
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // State
    let currentUser = null;
    let isGuest = false;
    let currentDepartment = 'Graphic';
    let scheduleData = Array.from({length: 12}, () => []);
    let currentMonth = new Date().getMonth(); // Start with current month
    let activeFilter = 'all';
    let searchQuery = '';
    let tempAttachments = [];
    let chartInstance = null;

    // Constants
    const MONTH_NAMES_TH = ["ม.ค.", "ก.พ.", "มี.ค.", "เม.ย.", "พ.ค.", "มิ.ย.", "ก.ค.", "ส.ค.", "ก.ย.", "ต.ค.", "พ.ย.", "ธ.ค."];
    const graphicChannels = ["Online Platform", "Social Media", "Offline/Print", "Internal"];
    const videoChannels = ["Short Video", "Online Platform", "Offline/Print", "Internal Clip"];
    const KPI_OPTIONS = [
        { value: "Financials (1.1)", label: "1.1 (P&L)" },
        { value: "Profitability (1.2)", label: "1.2 (Profit)" },
        { value: "Customer Exp (2.1)", label: "2.1 (Exp)" },
        { value: "Market Presence (2.3)", label: "2.3 (Market)" },
        { value: "N/A", label: "N/A" }
    ];

    // Auth Logic
    window.handleLogin = async (e) => {
        e.preventDefault();
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        try { await signInWithEmailAndPassword(auth, email, password); } 
        catch (e) { alert("Login failed: " + e.message); }
    };
    window.handleGuestLogin = async () => {
        try { await signInAnonymously(auth); } 
        catch (e) { alert("Guest failed: " + e.message); }
    };
    window.handleLogout = async () => await signOut(auth);

    onAuthStateChanged(auth, (user) => {
        currentUser = user;
        if (user) {
            isGuest = user.isAnonymous;
            document.getElementById('loginOverlay').classList.add('hidden');
            setupRealtimeListener();
            toggleDept(currentDepartment, false); // Initialize UI
        } else {
            document.getElementById('loginOverlay').classList.remove('hidden');
        }
    });

    // Data Logic
    function setupRealtimeListener() {
        const tasksRef = collection(db, 'artifacts', appId, 'public', 'data', 'tasks');
        onSnapshot(query(tasksRef), (snapshot) => {
            scheduleData = Array.from({length: 12}, () => []);
            snapshot.forEach((doc) => {
                const t = { id: doc.id, ...doc.data() };
                if(!t.department) t.department = 'Graphic';
                if(t.monthIndex >= 0 && t.monthIndex < 12) {
                    scheduleData[t.monthIndex].push(t);
                }
            });
            refreshView();
        });
    }

    // UI Logic
    window.toggleDept = function(dept, refresh = true) {
        if (!dept) {
            currentDepartment = currentDepartment === 'Graphic' ? 'Video' : 'Graphic';
        } else {
            currentDepartment = dept;
        }
        
        const icon = document.getElementById('topBarIcon');
        const iconBtn = document.getElementById('deptIconBtn');
        
        if (currentDepartment === 'Graphic') {
            icon.className = "fa-solid fa-palette text-black"; // Graphic Icon
        } else {
            icon.className = "fa-solid fa-video text-black"; // Video Icon
        }
        
        // Reset filters
        if(refresh) {
            activeFilter = 'all';
            refreshView();
        }
    };

    window.switchView = function(viewName) {
        // Reset nav icons
        document.getElementById('nav-feed').className = "text-2xl text-gray-400";
        document.getElementById('nav-search').className = "text-2xl text-gray-400";
        document.getElementById('nav-dashboard').className = "text-2xl text-gray-400";
        
        // Hide all views
        document.getElementById('view-feed').classList.add('hidden');
        document.getElementById('view-search').classList.add('hidden');
        document.getElementById('view-dashboard').classList.add('hidden');

        // Activate selected
        document.getElementById(`nav-${viewName}`).className = "text-2xl text-black";
        document.getElementById(`view-${viewName}`).classList.remove('hidden');

        if(viewName === 'feed') refreshView();
        if(viewName === 'search') {
            document.getElementById('searchInput').focus();
            handleSearch(); // Render search grid
        }
        if(viewName === 'dashboard') renderDashboard();
    };

    function refreshView() {
        renderStories();
        renderFilters();
        renderFeed();
    }

    window.loadMonth = function(idx) {
        currentMonth = idx;
        renderStories();
        renderFeed();
    }

    function renderStories() {
        const container = document.getElementById('storiesContainer');
        container.innerHTML = MONTH_NAMES_TH.map((m, i) => {
            const isActive = i === currentMonth;
            const ringClass = isActive ? 'story-ring-active' : 'story-ring-inactive';
            const count = scheduleData[i].filter(t => t.department === currentDepartment).length;
            
            return `
            <div class="flex flex-col items-center gap-1 cursor-pointer shrink-0" onclick="loadMonth(${i})">
                <div class="${ringClass} rounded-full w-[66px] h-[66px] flex items-center justify-center p-[2px]">
                    <div class="bg-white rounded-full w-full h-full flex flex-col items-center justify-center border-2 border-white overflow-hidden">
                        <span class="text-xs font-bold ${isActive ? 'text-black' : 'text-gray-400'}">${m}</span>
                        <span class="text-[9px] text-gray-400">${count}</span>
                    </div>
                </div>
                <span class="text-xs ${isActive ? 'font-medium' : 'text-gray-500'}">${m}</span>
            </div>`;
        }).join('');
        
        // Auto scroll to active story
        if(container.children[currentMonth]) {
            container.children[currentMonth].scrollIntoView({ behavior: 'smooth', inline: 'center' });
        }
    }

    function renderFilters() {
        const container = document.getElementById('filterContainer');
        const channels = currentDepartment === 'Graphic' ? graphicChannels : videoChannels;
        
        let html = `<button onclick="setFilter('all')" class="whitespace-nowrap px-4 py-1.5 rounded-lg text-sm font-medium transition ${activeFilter === 'all' ? 'bg-black text-white' : 'bg-gray-100 text-black border border-gray-200'}">All</button>`;
        
        channels.forEach(c => {
            const label = c.split(' ')[0]; // Shorten label
            const isActive = activeFilter === c;
            html += `<button onclick="setFilter('${c}')" class="whitespace-nowrap px-4 py-1.5 rounded-lg text-sm font-medium transition ${isActive ? 'bg-black text-white' : 'bg-gray-100 text-black border border-gray-200'}">${label}</button>`;
        });
        container.innerHTML = html;
    }

    window.setFilter = function(filter) {
        activeFilter = filter;
        renderFilters();
        renderFeed();
    }

    // --- FEED RENDERER (The Core) ---
    function renderFeed() {
        const container = document.getElementById('feedList');
        const allTasks = scheduleData[currentMonth].filter(t => t.department === currentDepartment);
        let filtered = activeFilter === 'all' ? allTasks : allTasks.filter(t => t.channel === activeFilter);

        if (filtered.length === 0) {
            container.innerHTML = `<div class="text-center py-20 text-gray-400"><i class="fa-solid fa-camera text-4xl mb-4"></i><p>No Posts Yet</p></div>`;
            return;
        }

        container.innerHTML = filtered.map(t => {
            const isDone = t.status === 'done';
            const isCritical = t.priority === 'C';
            const heartIcon = isDone ? 'fa-solid fa-heart text-red-500' : 'fa-regular fa-heart';
            const bookmarkIcon = isCritical ? 'fa-solid fa-bookmark text-black' : 'fa-regular fa-bookmark';
            
            // Image Handling (Carousel)
            let images = t.attachments || [];
            if (images.length === 0 && t.imageUrl) images = [{ url: t.imageUrl }];
            if (images.length === 0) images = [{ url: 'https://placehold.co/600x600/f5f5f5/a3a3a3?text=No+Image', isPlaceholder: true }];

            const slides = images.map(img => 
                `<div class="snap-center shrink-0 w-full aspect-square relative bg-gray-100">
                    <img src="${img.url}" class="w-full h-full object-cover">
                    ${img.caption ? `<div class="absolute bottom-2 left-2 bg-black/50 text-white text-xs px-2 py-1 rounded backdrop-blur-sm">${img.caption}</div>` : ''}
                </div>`
            ).join('');

            const dots = images.length > 1 ? 
                `<div class="absolute top-3 right-3 bg-black/60 text-white text-xs px-2 py-1 rounded-full backdrop-blur-md">1/${images.length}</div>` : '';

            // Creator & Remark
            const creator = t.createdBy ? t.createdBy.split('@')[0] : 'guest';
            const avatarUrl = `https://ui-avatars.com/api/?name=${creator}&background=random`;
            const remarkDisplay = t.remark ? `<div class="mt-1 text-sm"><span class="font-bold mr-1">${creator}</span>${t.remark}</div>` : '';

            return `
            <article class="bg-white border-b border-gray-100 mb-2">
                <!-- Header -->
                <div class="flex items-center justify-between px-3 py-3">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 rounded-full bg-gray-200 overflow-hidden border border-gray-100">
                            <img src="${avatarUrl}" class="w-full h-full object-cover">
                        </div>
                        <div>
                            <div class="text-sm font-semibold leading-none">${creator}</div>
                            <div class="text-[10px] text-gray-500 leading-none mt-0.5">${t.channel}</div>
                        </div>
                    </div>
                    <button onclick="openEditTaskModal('${t.id}')" class="text-gray-600"><i class="fa-solid fa-ellipsis"></i></button>
                </div>

                <!-- Image Carousel -->
                <div class="relative w-full aspect-square overflow-x-auto flex snap-x-mandatory no-scrollbar bg-gray-50">
                    ${slides}
                    ${dots}
                </div>

                <!-- Actions -->
                <div class="px-3 py-2">
                    <div class="flex items-center justify-between text-2xl mb-2">
                        <div class="flex items-center gap-4">
                            <button onclick="toggleStatus('${t.id}', '${t.status}')" class="hover:opacity-70 active:scale-90 transition"><i class="${heartIcon}"></i></button>
                            <button onclick="openEditTaskModal('${t.id}')" class="hover:opacity-70"><i class="fa-regular fa-comment"></i></button>
                            <button class="hover:opacity-70"><i class="fa-regular fa-paper-plane"></i></button>
                        </div>
                        <button onclick="togglePriority('${t.id}', '${t.priority}')" class="hover:opacity-70"><i class="${bookmarkIcon}"></i></button>
                    </div>

                    <!-- Likes/Status Text -->
                    <div class="font-semibold text-sm mb-1">${isDone ? 'Completed' : 'In Progress'}</div>

                    <!-- Caption -->
                    <div class="text-sm mb-1">
                        <span class="font-bold mr-1">${creator}</span>
                        ${t.title} <span class="text-blue-900">${t.kpi ? '#' + t.kpi.split(' ')[0] : ''}</span>
                    </div>
                    
                    <!-- Description -->
                    ${t.desc ? `<div class="text-sm text-gray-500 line-clamp-2 cursor-pointer" onclick="this.classList.toggle('line-clamp-2')">${t.desc}</div>` : ''}

                    <!-- Remarks -->
                    ${remarkDisplay}

                    <!-- Date -->
                    <div class="text-[10px] text-gray-400 uppercase mt-1">Due ${t.dueDate || 'No Date'}</div>
                </div>
            </article>`;
        }).join('');
    }

    // --- ACTIONS ---
    window.toggleStatus = async (id, currentStatus) => {
        if(isGuest) return;
        const newStatus = currentStatus === 'done' ? 'doing' : 'done'; // Toggle Done/Doing
        // Visual feedback immediately could be added here
        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tasks', id), { status: newStatus });
    };

    window.togglePriority = async (id, currentPriority) => {
        if(isGuest) return;
        const newPriority = currentPriority === 'C' ? 'S' : 'C';
        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tasks', id), { priority: newPriority });
    };

    // --- SEARCH GRID RENDERER ---
    window.handleSearch = function() {
        const q = document.getElementById('searchInput').value.toLowerCase();
        const container = document.getElementById('searchGrid');
        
        // Flatten all data
        let allResults = scheduleData.flat().filter(t => t.department === currentDepartment);
        
        if (q) {
            allResults = allResults.filter(t => t.title.toLowerCase().includes(q) || t.desc.toLowerCase().includes(q));
        }

        container.innerHTML = allResults.map(t => {
            const img = (t.attachments?.[0]?.url || t.imageUrl) || 'https://placehold.co/300x300/eee/ccc?text=No+Img';
            return `
            <div onclick="openEditTaskModal('${t.id}')" class="aspect-square bg-gray-200 cursor-pointer relative group overflow-hidden">
                <img src="${img}" class="w-full h-full object-cover">
                <div class="absolute inset-0 bg-black/30 hidden group-hover:flex items-center justify-center text-white gap-3 font-bold">
                    <span><i class="fa-solid fa-heart"></i> ${t.status==='done'?'1':'0'}</span>
                </div>
            </div>`;
        }).join('');
    }

    // --- DASHBOARD RENDERER ---
    window.renderDashboard = function() {
        let counts = { done: 0, total: 0, critical: 0 };
        const allDeptTasks = scheduleData.flat().filter(t => t.department === currentDepartment);
        
        allDeptTasks.forEach(t => {
            counts.total++;
            if(t.status === 'done') counts.done++;
            if(t.priority === 'C') counts.critical++;
        });

        // Stats HTML
        document.getElementById('dashboardStats').innerHTML = `
            <div class="grid grid-cols-3 gap-4 text-center">
                <div class="bg-gray-50 p-3 rounded-lg">
                    <div class="text-xl font-bold">${counts.total}</div>
                    <div class="text-xs text-gray-500">Posts</div>
                </div>
                <div class="bg-gray-50 p-3 rounded-lg">
                    <div class="text-xl font-bold text-green-500">${counts.done}</div>
                    <div class="text-xs text-gray-500">Completed</div>
                </div>
                <div class="bg-gray-50 p-3 rounded-lg">
                    <div class="text-xl font-bold text-red-500">${counts.critical}</div>
                    <div class="text-xs text-gray-500">Critical</div>
                </div>
            </div>
        `;

        // Simple Chart Data (Monthly)
        const monthlyData = scheduleData.map(m => {
            const dept = m.filter(t => t.department === currentDepartment);
            const done = dept.filter(t => t.status === 'done').length;
            return dept.length ? Math.round((done / dept.length) * 100) : 0;
        });

        const ctx = document.getElementById('monthlyChart').getContext('2d');
        if(chartInstance) chartInstance.destroy();
        chartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: MONTH_NAMES_TH,
                datasets: [{
                    label: '% Completion',
                    data: monthlyData,
                    backgroundColor: currentDepartment==='Graphic' ? '#14b8a6' : '#0ea5e9',
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { y: { beginAtZero: true, max: 100, display: false }, x: { grid: { display: false } } },
                plugins: { legend: { display: false } }
            }
        });
    }

    // --- MODAL FUNCTIONS (Simplified from previous version) ---
    window.openAddTaskModal = function() {
        document.getElementById('editingTaskId').value = '';
        document.getElementById('modalTitle').innerText = 'New Post';
        document.getElementById('newTaskTitle').value = '';
        document.getElementById('newTaskDesc').value = '';
        document.getElementById('newTaskRemark').value = '';
        document.getElementById('newTaskDueDate').value = '';
        tempAttachments = [];
        renderModalImages();
        
        // Populate Selects
        document.getElementById('newTaskMonth').innerHTML = MONTH_NAMES_TH.map((m,i) => `<option value="${i}" ${i===currentMonth?'selected':''}>${m}</option>`).join('');
        const chans = currentDepartment === 'Graphic' ? graphicChannels : videoChannels;
        document.getElementById('newTaskChannel').innerHTML = chans.map(c => `<option value="${c}">${c}</option>`).join('');
        document.getElementById('newTaskKPI').innerHTML = KPI_OPTIONS.map(o => `<option value="${o.value}">${o.label}</option>`).join('');
        
        document.getElementById('addTaskModal').classList.remove('hidden');
    }

    window.openEditTaskModal = function(id) {
        const task = scheduleData.flat().find(t => t.id === id);
        if(!task) return;
        
        document.getElementById('editingTaskId').value = id;
        document.getElementById('modalTitle').innerText = 'Edit Post';
        document.getElementById('newTaskTitle').value = task.title;
        document.getElementById('newTaskDesc').value = task.desc;
        document.getElementById('newTaskRemark').value = task.remark || '';
        document.getElementById('newTaskDueDate').value = task.dueDate || '';
        
        tempAttachments = [];
        if(task.attachments) tempAttachments = JSON.parse(JSON.stringify(task.attachments));
        else if(task.imageUrl) tempAttachments.push({url: task.imageUrl});
        renderModalImages();

        document.getElementById('newTaskMonth').innerHTML = MONTH_NAMES_TH.map((m,i) => `<option value="${i}" ${i===task.monthIndex?'selected':''}>${m}</option>`).join('');
        const chans = currentDepartment === 'Graphic' ? graphicChannels : videoChannels;
        document.getElementById('newTaskChannel').innerHTML = chans.map(c => `<option value="${c}" ${c===task.channel?'selected':''}>${c}</option>`).join('');
        document.getElementById('newTaskKPI').innerHTML = KPI_OPTIONS.map(o => `<option value="${o.value}" ${o.value===task.kpi?'selected':''}>${o.label}</option>`).join('');
        document.getElementById('newTaskPriority').value = task.priority;

        document.getElementById('addTaskModal').classList.remove('hidden');
    }

    window.closeAddTaskModal = () => document.getElementById('addTaskModal').classList.add('hidden');

    // --- Image Handling ---
    window.handleImageSelect = function(input) {
        const files = Array.from(input.files);
        if(!files.length) return;
        const promises = files.map(file => {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const scale = 800 / Math.max(img.width, img.height);
                        canvas.width = img.width * (scale < 1 ? scale : 1);
                        canvas.height = img.height * (scale < 1 ? scale : 1);
                        canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
                        resolve({url: canvas.toDataURL('image/jpeg', 0.7)});
                    }
                }
            });
        });
        Promise.all(promises).then(imgs => {
            tempAttachments = [...tempAttachments, ...imgs];
            renderModalImages();
            input.value = '';
        });
    }

    function renderModalImages() {
        const container = document.getElementById('modalImagePreview');
        // Keep the upload button
        const uploadBtn = container.firstElementChild;
        container.innerHTML = '';
        container.appendChild(uploadBtn);
        
        tempAttachments.forEach((img, idx) => {
            const div = document.createElement('div');
            div.className = 'relative shrink-0 w-24 h-24 bg-gray-100 border border-gray-300 rounded overflow-hidden group';
            div.innerHTML = `
                <img src="${img.url}" class="w-full h-full object-cover">
                <button onclick="removeAttachment(${idx})" class="absolute top-1 right-1 bg-black/50 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs"><i class="fa-solid fa-xmark"></i></button>
            `;
            container.insertBefore(div, uploadBtn);
        });
    }
    
    window.removeAttachment = (idx) => {
        tempAttachments.splice(idx, 1);
        renderModalImages();
    }

    window.handleSaveTask = async () => {
        const id = document.getElementById('editingTaskId').value;
        const title = document.getElementById('newTaskTitle').value;
        if(!title) return alert("Please enter a caption (Title)");

        const data = {
            title,
            desc: document.getElementById('newTaskDesc').value,
            remark: document.getElementById('newTaskRemark').value,
            monthIndex: parseInt(document.getElementById('newTaskMonth').value),
            dueDate: document.getElementById('newTaskDueDate').value,
            channel: document.getElementById('newTaskChannel').value,
            kpi: document.getElementById('newTaskKPI').value,
            priority: document.getElementById('newTaskPriority').value,
            department: currentDepartment,
            attachments: tempAttachments,
            imageUrl: tempAttachments[0]?.url || ''
        };

        const ref = collection(db, 'artifacts', appId, 'public', 'data', 'tasks');
        if(id) await updateDoc(doc(ref, id), data);
        else {
            data.status = 'doing'; // Default to Doing/In Progress
            data.createdAt = new Date().toISOString();
            data.createdBy = currentUser?.email || 'Guest';
            await addDoc(ref, data);
        }
        closeAddTaskModal();
    }

    // Init
    window.onload = function() {
        const envConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : firebaseConfig;
        if (typeof __firebase_config !== 'undefined') initializeApp(envConfig);
        signInAnonymously(getAuth()); // Default fallback
    }
</script>
</body>
</html>
